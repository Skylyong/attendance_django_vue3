{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport { computed } from 'vue';\nimport { reactive, watch, nextTick, unref } from 'vue';\nimport cloneDeep from 'lodash-es/cloneDeep';\nimport intersection from 'lodash-es/intersection';\nimport isEqual from 'lodash-es/isEqual';\nimport debounce from 'lodash-es/debounce';\nimport omit from 'lodash-es/omit';\nimport { validateRules } from './utils/validateUtil';\nimport { defaultValidateMessages } from './utils/messages';\nimport { allPromiseFinish } from './utils/asyncUtil';\n\nfunction isRequired(rules) {\n  var isRequired = false;\n\n  if (rules && rules.length) {\n    rules.every(function (rule) {\n      if (rule.required) {\n        isRequired = true;\n        return false;\n      }\n\n      return true;\n    });\n  }\n\n  return isRequired;\n}\n\nfunction toArray(value) {\n  if (value === undefined || value === null) {\n    return [];\n  }\n\n  return Array.isArray(value) ? value : [value];\n}\n\nfunction getPropByPath(obj, path, strict) {\n  var tempObj = obj;\n  path = path.replace(/\\[(\\w+)\\]/g, '.$1');\n  path = path.replace(/^\\./, '');\n  var keyArr = path.split('.');\n  var i = 0;\n\n  for (var len = keyArr.length; i < len - 1; ++i) {\n    if (!tempObj && !strict) break;\n    var key = keyArr[i];\n\n    if (key in tempObj) {\n      tempObj = tempObj[key];\n    } else {\n      if (strict) {\n        throw new Error('please transfer a valid name path to validate!');\n      }\n\n      break;\n    }\n  }\n\n  return {\n    o: tempObj,\n    k: keyArr[i],\n    v: tempObj ? tempObj[keyArr[i]] : null,\n    isValid: tempObj && keyArr[i] in tempObj\n  };\n}\n\nfunction useForm(modelRef, rulesRef, options) {\n  var initialModel = cloneDeep(unref(modelRef));\n  var validateInfos = reactive({});\n  var rulesKeys = computed(function () {\n    return rulesRef ? Object.keys(unref(rulesRef)) : [];\n  });\n  watch(rulesKeys, function () {\n    var newValidateInfos = {};\n    rulesKeys.value.forEach(function (key) {\n      newValidateInfos[key] = validateInfos[key] || {\n        autoLink: false,\n        required: isRequired(unref(rulesRef)[key])\n      };\n      delete validateInfos[key];\n    });\n\n    for (var key in validateInfos) {\n      if (Object.prototype.hasOwnProperty.call(validateInfos, key)) {\n        delete validateInfos[key];\n      }\n    }\n\n    _extends(validateInfos, newValidateInfos);\n  }, {\n    immediate: true\n  });\n\n  var resetFields = function resetFields(newValues) {\n    _extends(unref(modelRef), _extends(_extends({}, cloneDeep(initialModel)), newValues));\n\n    nextTick(function () {\n      Object.keys(validateInfos).forEach(function (key) {\n        validateInfos[key] = {\n          autoLink: false,\n          required: isRequired(unref(rulesRef)[key])\n        };\n      });\n    });\n  };\n\n  var filterRules = function filterRules() {\n    var rules = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n    var trigger = arguments.length > 1 ? arguments[1] : undefined;\n\n    if (!trigger.length) {\n      return rules;\n    } else {\n      return rules.filter(function (rule) {\n        var triggerList = toArray(rule.trigger || 'change');\n        return intersection(triggerList, trigger).length;\n      });\n    }\n  };\n\n  var lastValidatePromise = null;\n\n  var validateFields = function validateFields(names) {\n    var option = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    var strict = arguments.length > 2 ? arguments[2] : undefined; // Collect result in promise list\n\n    var promiseList = [];\n    var values = {};\n\n    var _loop = function _loop(i) {\n      var name = names[i];\n      var prop = getPropByPath(unref(modelRef), name, strict);\n      if (!prop.isValid) return \"continue\";\n      values[name] = prop.v;\n      var rules = filterRules(unref(rulesRef)[name], toArray(option && option.trigger));\n\n      if (rules.length) {\n        promiseList.push(validateField(name, prop.v, rules, option || {}).then(function () {\n          return {\n            name: name,\n            errors: [],\n            warnings: []\n          };\n        }).catch(function (ruleErrors) {\n          var mergedErrors = [];\n          var mergedWarnings = [];\n          ruleErrors.forEach(function (_ref) {\n            var warningOnly = _ref.rule.warningOnly,\n                errors = _ref.errors;\n\n            if (warningOnly) {\n              mergedWarnings.push.apply(mergedWarnings, _toConsumableArray(errors));\n            } else {\n              mergedErrors.push.apply(mergedErrors, _toConsumableArray(errors));\n            }\n          });\n\n          if (mergedErrors.length) {\n            return Promise.reject({\n              name: name,\n              errors: mergedErrors,\n              warnings: mergedWarnings\n            });\n          }\n\n          return {\n            name: name,\n            errors: mergedErrors,\n            warnings: mergedWarnings\n          };\n        }));\n      }\n    };\n\n    for (var i = 0; i < names.length; i++) {\n      var _ret = _loop(i);\n\n      if (_ret === \"continue\") continue;\n    }\n\n    var summaryPromise = allPromiseFinish(promiseList);\n    lastValidatePromise = summaryPromise;\n    var returnPromise = summaryPromise.then(function () {\n      if (lastValidatePromise === summaryPromise) {\n        return Promise.resolve(values);\n      }\n\n      return Promise.reject([]);\n    }).catch(function (results) {\n      var errorList = results.filter(function (result) {\n        return result && result.errors.length;\n      });\n      return Promise.reject({\n        values: values,\n        errorFields: errorList,\n        outOfDate: lastValidatePromise !== summaryPromise\n      });\n    }); // Do not throw in console\n\n    returnPromise.catch(function (e) {\n      return e;\n    });\n    return returnPromise;\n  };\n\n  var validateField = function validateField(name, value, rules) {\n    var option = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};\n    var promise = validateRules([name], value, rules, _extends({\n      validateMessages: defaultValidateMessages\n    }, option), !!option.validateFirst);\n\n    if (!validateInfos[name]) {\n      return promise.catch(function (e) {\n        return e;\n      });\n    }\n\n    validateInfos[name].validateStatus = 'validating';\n    promise.catch(function (e) {\n      return e;\n    }).then(function () {\n      var results = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n\n      if (validateInfos[name].validateStatus === 'validating') {\n        var res = results.filter(function (result) {\n          return result && result.errors.length;\n        });\n        validateInfos[name].validateStatus = res.length ? 'error' : 'success';\n        validateInfos[name].help = res.length ? res.map(function (r) {\n          return r.errors;\n        }) : '';\n      }\n    });\n    return promise;\n  };\n\n  var validate = function validate(names, option) {\n    var keys = [];\n    var strict = true;\n\n    if (!names) {\n      strict = false;\n      keys = rulesKeys.value;\n    } else if (Array.isArray(names)) {\n      keys = names;\n    } else {\n      keys = [names];\n    }\n\n    var promises = validateFields(keys, option || {}, strict); // Do not throw in console\n\n    promises.catch(function (e) {\n      return e;\n    });\n    return promises;\n  };\n\n  var clearValidate = function clearValidate(names) {\n    var keys = [];\n\n    if (!names) {\n      keys = rulesKeys.value;\n    } else if (Array.isArray(names)) {\n      keys = names;\n    } else {\n      keys = [names];\n    }\n\n    keys.forEach(function (key) {\n      validateInfos[key] && _extends(validateInfos[key], {\n        validateStatus: '',\n        help: ''\n      });\n    });\n  };\n\n  var mergeValidateInfo = function mergeValidateInfo(items) {\n    var info = {\n      autoLink: false\n    };\n    var help = [];\n    var infos = Array.isArray(items) ? items : [items];\n\n    for (var i = 0; i < infos.length; i++) {\n      var arg = infos[i];\n\n      if ((arg === null || arg === void 0 ? void 0 : arg.validateStatus) === 'error') {\n        info.validateStatus = 'error';\n        arg.help && help.push(arg.help);\n      }\n\n      info.required = info.required || (arg === null || arg === void 0 ? void 0 : arg.required);\n    }\n\n    info.help = help;\n    return info;\n  };\n\n  var oldModel = initialModel;\n  var isFirstTime = true;\n\n  var modelFn = function modelFn(model) {\n    var names = [];\n    rulesKeys.value.forEach(function (key) {\n      var prop = getPropByPath(model, key, false);\n      var oldProp = getPropByPath(oldModel, key, false);\n      var isFirstValidation = isFirstTime && (options === null || options === void 0 ? void 0 : options.immediate) && prop.isValid;\n\n      if (isFirstValidation || !isEqual(prop.v, oldProp.v)) {\n        names.push(key);\n      }\n    });\n    validate(names, {\n      trigger: 'change'\n    });\n    isFirstTime = false;\n    oldModel = cloneDeep(model);\n  };\n\n  var debounceOptions = options === null || options === void 0 ? void 0 : options.debounce;\n  watch(modelRef, debounceOptions && debounceOptions.wait ? debounce(modelFn, debounceOptions.wait, omit(debounceOptions, ['wait'])) : modelFn, {\n    immediate: options && !!options.immediate,\n    deep: true\n  });\n  watch(rulesRef, function () {\n    if (options && options.validateOnRuleChange) {\n      validate();\n    }\n  }, {\n    deep: true\n  });\n  return {\n    modelRef: modelRef,\n    rulesRef: rulesRef,\n    initialModel: initialModel,\n    validateInfos: validateInfos,\n    resetFields: resetFields,\n    validate: validate,\n    validateField: validateField,\n    mergeValidateInfo: mergeValidateInfo,\n    clearValidate: clearValidate\n  };\n}\n\nexport default useForm;","map":{"version":3,"sources":["/Users/lyong/Desktop/myproj/appfront/node_modules/ant-design-vue/es/form/useForm.js"],"names":["_toConsumableArray","_extends","computed","reactive","watch","nextTick","unref","cloneDeep","intersection","isEqual","debounce","omit","validateRules","defaultValidateMessages","allPromiseFinish","isRequired","rules","length","every","rule","required","toArray","value","undefined","Array","isArray","getPropByPath","obj","path","strict","tempObj","replace","keyArr","split","i","len","key","Error","o","k","v","isValid","useForm","modelRef","rulesRef","options","initialModel","validateInfos","rulesKeys","Object","keys","newValidateInfos","forEach","autoLink","prototype","hasOwnProperty","call","immediate","resetFields","newValues","filterRules","arguments","trigger","filter","triggerList","lastValidatePromise","validateFields","names","option","promiseList","values","_loop","name","prop","push","validateField","then","errors","warnings","catch","ruleErrors","mergedErrors","mergedWarnings","_ref","warningOnly","apply","Promise","reject","_ret","summaryPromise","returnPromise","resolve","results","errorList","result","errorFields","outOfDate","e","promise","validateMessages","validateFirst","validateStatus","res","help","map","r","validate","promises","clearValidate","mergeValidateInfo","items","info","infos","arg","oldModel","isFirstTime","modelFn","model","oldProp","isFirstValidation","debounceOptions","wait","deep","validateOnRuleChange"],"mappings":"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","sourcesContent":["import _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport { computed } from 'vue';\nimport { reactive, watch, nextTick, unref } from 'vue';\nimport cloneDeep from 'lodash-es/cloneDeep';\nimport intersection from 'lodash-es/intersection';\nimport isEqual from 'lodash-es/isEqual';\nimport debounce from 'lodash-es/debounce';\nimport omit from 'lodash-es/omit';\nimport { validateRules } from './utils/validateUtil';\nimport { defaultValidateMessages } from './utils/messages';\nimport { allPromiseFinish } from './utils/asyncUtil';\n\nfunction isRequired(rules) {\n  var isRequired = false;\n\n  if (rules && rules.length) {\n    rules.every(function (rule) {\n      if (rule.required) {\n        isRequired = true;\n        return false;\n      }\n\n      return true;\n    });\n  }\n\n  return isRequired;\n}\n\nfunction toArray(value) {\n  if (value === undefined || value === null) {\n    return [];\n  }\n\n  return Array.isArray(value) ? value : [value];\n}\n\nfunction getPropByPath(obj, path, strict) {\n  var tempObj = obj;\n  path = path.replace(/\\[(\\w+)\\]/g, '.$1');\n  path = path.replace(/^\\./, '');\n  var keyArr = path.split('.');\n  var i = 0;\n\n  for (var len = keyArr.length; i < len - 1; ++i) {\n    if (!tempObj && !strict) break;\n    var key = keyArr[i];\n\n    if (key in tempObj) {\n      tempObj = tempObj[key];\n    } else {\n      if (strict) {\n        throw new Error('please transfer a valid name path to validate!');\n      }\n\n      break;\n    }\n  }\n\n  return {\n    o: tempObj,\n    k: keyArr[i],\n    v: tempObj ? tempObj[keyArr[i]] : null,\n    isValid: tempObj && keyArr[i] in tempObj\n  };\n}\n\nfunction useForm(modelRef, rulesRef, options) {\n  var initialModel = cloneDeep(unref(modelRef));\n  var validateInfos = reactive({});\n  var rulesKeys = computed(function () {\n    return rulesRef ? Object.keys(unref(rulesRef)) : [];\n  });\n  watch(rulesKeys, function () {\n    var newValidateInfos = {};\n    rulesKeys.value.forEach(function (key) {\n      newValidateInfos[key] = validateInfos[key] || {\n        autoLink: false,\n        required: isRequired(unref(rulesRef)[key])\n      };\n      delete validateInfos[key];\n    });\n\n    for (var key in validateInfos) {\n      if (Object.prototype.hasOwnProperty.call(validateInfos, key)) {\n        delete validateInfos[key];\n      }\n    }\n\n    _extends(validateInfos, newValidateInfos);\n  }, {\n    immediate: true\n  });\n\n  var resetFields = function resetFields(newValues) {\n    _extends(unref(modelRef), _extends(_extends({}, cloneDeep(initialModel)), newValues));\n\n    nextTick(function () {\n      Object.keys(validateInfos).forEach(function (key) {\n        validateInfos[key] = {\n          autoLink: false,\n          required: isRequired(unref(rulesRef)[key])\n        };\n      });\n    });\n  };\n\n  var filterRules = function filterRules() {\n    var rules = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n    var trigger = arguments.length > 1 ? arguments[1] : undefined;\n\n    if (!trigger.length) {\n      return rules;\n    } else {\n      return rules.filter(function (rule) {\n        var triggerList = toArray(rule.trigger || 'change');\n        return intersection(triggerList, trigger).length;\n      });\n    }\n  };\n\n  var lastValidatePromise = null;\n\n  var validateFields = function validateFields(names) {\n    var option = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    var strict = arguments.length > 2 ? arguments[2] : undefined;\n    // Collect result in promise list\n    var promiseList = [];\n    var values = {};\n\n    var _loop = function _loop(i) {\n      var name = names[i];\n      var prop = getPropByPath(unref(modelRef), name, strict);\n      if (!prop.isValid) return \"continue\";\n      values[name] = prop.v;\n      var rules = filterRules(unref(rulesRef)[name], toArray(option && option.trigger));\n\n      if (rules.length) {\n        promiseList.push(validateField(name, prop.v, rules, option || {}).then(function () {\n          return {\n            name: name,\n            errors: [],\n            warnings: []\n          };\n        }).catch(function (ruleErrors) {\n          var mergedErrors = [];\n          var mergedWarnings = [];\n          ruleErrors.forEach(function (_ref) {\n            var warningOnly = _ref.rule.warningOnly,\n                errors = _ref.errors;\n\n            if (warningOnly) {\n              mergedWarnings.push.apply(mergedWarnings, _toConsumableArray(errors));\n            } else {\n              mergedErrors.push.apply(mergedErrors, _toConsumableArray(errors));\n            }\n          });\n\n          if (mergedErrors.length) {\n            return Promise.reject({\n              name: name,\n              errors: mergedErrors,\n              warnings: mergedWarnings\n            });\n          }\n\n          return {\n            name: name,\n            errors: mergedErrors,\n            warnings: mergedWarnings\n          };\n        }));\n      }\n    };\n\n    for (var i = 0; i < names.length; i++) {\n      var _ret = _loop(i);\n\n      if (_ret === \"continue\") continue;\n    }\n\n    var summaryPromise = allPromiseFinish(promiseList);\n    lastValidatePromise = summaryPromise;\n    var returnPromise = summaryPromise.then(function () {\n      if (lastValidatePromise === summaryPromise) {\n        return Promise.resolve(values);\n      }\n\n      return Promise.reject([]);\n    }).catch(function (results) {\n      var errorList = results.filter(function (result) {\n        return result && result.errors.length;\n      });\n      return Promise.reject({\n        values: values,\n        errorFields: errorList,\n        outOfDate: lastValidatePromise !== summaryPromise\n      });\n    }); // Do not throw in console\n\n    returnPromise.catch(function (e) {\n      return e;\n    });\n    return returnPromise;\n  };\n\n  var validateField = function validateField(name, value, rules) {\n    var option = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};\n    var promise = validateRules([name], value, rules, _extends({\n      validateMessages: defaultValidateMessages\n    }, option), !!option.validateFirst);\n\n    if (!validateInfos[name]) {\n      return promise.catch(function (e) {\n        return e;\n      });\n    }\n\n    validateInfos[name].validateStatus = 'validating';\n    promise.catch(function (e) {\n      return e;\n    }).then(function () {\n      var results = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n\n      if (validateInfos[name].validateStatus === 'validating') {\n        var res = results.filter(function (result) {\n          return result && result.errors.length;\n        });\n        validateInfos[name].validateStatus = res.length ? 'error' : 'success';\n        validateInfos[name].help = res.length ? res.map(function (r) {\n          return r.errors;\n        }) : '';\n      }\n    });\n    return promise;\n  };\n\n  var validate = function validate(names, option) {\n    var keys = [];\n    var strict = true;\n\n    if (!names) {\n      strict = false;\n      keys = rulesKeys.value;\n    } else if (Array.isArray(names)) {\n      keys = names;\n    } else {\n      keys = [names];\n    }\n\n    var promises = validateFields(keys, option || {}, strict); // Do not throw in console\n\n    promises.catch(function (e) {\n      return e;\n    });\n    return promises;\n  };\n\n  var clearValidate = function clearValidate(names) {\n    var keys = [];\n\n    if (!names) {\n      keys = rulesKeys.value;\n    } else if (Array.isArray(names)) {\n      keys = names;\n    } else {\n      keys = [names];\n    }\n\n    keys.forEach(function (key) {\n      validateInfos[key] && _extends(validateInfos[key], {\n        validateStatus: '',\n        help: ''\n      });\n    });\n  };\n\n  var mergeValidateInfo = function mergeValidateInfo(items) {\n    var info = {\n      autoLink: false\n    };\n    var help = [];\n    var infos = Array.isArray(items) ? items : [items];\n\n    for (var i = 0; i < infos.length; i++) {\n      var arg = infos[i];\n\n      if ((arg === null || arg === void 0 ? void 0 : arg.validateStatus) === 'error') {\n        info.validateStatus = 'error';\n        arg.help && help.push(arg.help);\n      }\n\n      info.required = info.required || (arg === null || arg === void 0 ? void 0 : arg.required);\n    }\n\n    info.help = help;\n    return info;\n  };\n\n  var oldModel = initialModel;\n  var isFirstTime = true;\n\n  var modelFn = function modelFn(model) {\n    var names = [];\n    rulesKeys.value.forEach(function (key) {\n      var prop = getPropByPath(model, key, false);\n      var oldProp = getPropByPath(oldModel, key, false);\n      var isFirstValidation = isFirstTime && (options === null || options === void 0 ? void 0 : options.immediate) && prop.isValid;\n\n      if (isFirstValidation || !isEqual(prop.v, oldProp.v)) {\n        names.push(key);\n      }\n    });\n    validate(names, {\n      trigger: 'change'\n    });\n    isFirstTime = false;\n    oldModel = cloneDeep(model);\n  };\n\n  var debounceOptions = options === null || options === void 0 ? void 0 : options.debounce;\n  watch(modelRef, debounceOptions && debounceOptions.wait ? debounce(modelFn, debounceOptions.wait, omit(debounceOptions, ['wait'])) : modelFn, {\n    immediate: options && !!options.immediate,\n    deep: true\n  });\n  watch(rulesRef, function () {\n    if (options && options.validateOnRuleChange) {\n      validate();\n    }\n  }, {\n    deep: true\n  });\n  return {\n    modelRef: modelRef,\n    rulesRef: rulesRef,\n    initialModel: initialModel,\n    validateInfos: validateInfos,\n    resetFields: resetFields,\n    validate: validate,\n    validateField: validateField,\n    mergeValidateInfo: mergeValidateInfo,\n    clearValidate: clearValidate\n  };\n}\n\nexport default useForm;"]},"metadata":{},"sourceType":"module"}