"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.msgQueue=exports.default=exports.allActivedModals=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_event=require("../../tools/event"),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_button=_interopRequireDefault(require("../../button/src/button"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},allActivedModals=[];exports.allActivedModals=allActivedModals;var msgQueue=[];exports.msgQueue=msgQueue;var _default2=(0,_vue.defineComponent)({name:"VxeModal",props:{modelValue:Boolean,id:String,type:{type:String,default:"modal"},loading:{type:Boolean,default:null},status:String,iconStatus:String,className:String,top:{type:[Number,String],default:function(){return _conf.default.modal.top}},position:[String,Object],title:String,duration:{type:[Number,String],default:function(){return _conf.default.modal.duration}},message:[Number,String],content:[Number,String],cancelButtonText:{type:String,default:function(){return _conf.default.modal.cancelButtonText}},confirmButtonText:{type:String,default:function(){return _conf.default.modal.confirmButtonText}},lockView:{type:Boolean,default:function(){return _conf.default.modal.lockView}},lockScroll:Boolean,mask:{type:Boolean,default:function(){return _conf.default.modal.mask}},maskClosable:{type:Boolean,default:function(){return _conf.default.modal.maskClosable}},escClosable:{type:Boolean,default:function(){return _conf.default.modal.escClosable}},resize:Boolean,showHeader:{type:Boolean,default:function(){return _conf.default.modal.showHeader}},showFooter:{type:Boolean,default:function(){return _conf.default.modal.showFooter}},showZoom:Boolean,showClose:{type:Boolean,default:function(){return _conf.default.modal.showClose}},dblclickZoom:{type:Boolean,default:function(){return _conf.default.modal.dblclickZoom}},width:[Number,String],height:[Number,String],minWidth:{type:[Number,String],default:function(){return _conf.default.modal.minWidth}},minHeight:{type:[Number,String],default:function(){return _conf.default.modal.minHeight}},zIndex:Number,marginSize:{type:[Number,String],default:function(){return _conf.default.modal.marginSize}},fullscreen:Boolean,draggable:{type:Boolean,default:function(){return _conf.default.modal.draggable}},remember:{type:Boolean,default:function(){return _conf.default.modal.remember}},destroyOnClose:{type:Boolean,default:function(){return _conf.default.modal.destroyOnClose}},showTitleOverflow:{type:Boolean,default:function(){return _conf.default.modal.showTitleOverflow}},transfer:{type:Boolean,default:function(){return _conf.default.modal.transfer}},storage:{type:Boolean,default:function(){return _conf.default.modal.storage}},storageKey:{type:String,default:function(){return _conf.default.modal.storageKey}},animat:{type:Boolean,default:function(){return _conf.default.modal.animat}},size:{type:String,default:function(){return _conf.default.modal.size||_conf.default.size}},beforeHideMethod:{type:Function,default:function(){return _conf.default.modal.beforeHideMethod}},slots:Object},emits:["update:modelValue","show","hide","before-hide","close","confirm","cancel","zoom"],setup:function(z,e){function l(){var e=z.width,t=z.height,o=O();return o.style.width=""+(e?isNaN(e)?e:e+"px":""),o.style.height=""+(t?isNaN(t)?t:t+"px":""),(0,_vue.nextTick)()}function d(){return(0,_vue.nextTick)().then(function(){var e=z.position,t=_xeUtils.default.toNumber(z.marginSize),o=O(),n=document.documentElement.clientWidth||document.body.clientWidth,i=document.documentElement.clientHeight||document.body.clientHeight,l="center"===e,u=_xeUtils.default.isString(e)?{top:e,left:e}:Object.assign({},e),a=u.top,s=u.left,r=l||"center"===a,e="",u="",u=s&&!(l||"center"===s)?isNaN(s)?s:s+"px":Math.max(t,n/2-o.offsetWidth/2)+"px",e=a&&!r?isNaN(a)?a:a+"px":Math.max(t,i/2-o.offsetHeight/2)+"px";o.style.top=e,o.style.left=u})}function u(e){var t="close";S.dispatchEvent(t,{type:t},e),C(t)}function t(e){var t="confirm";S.dispatchEvent(t,{type:t},e),C(t)}function o(e){var t="cancel";S.dispatchEvent(t,{type:t},e),C(t)}function f(){return(0,_vue.nextTick)().then(function(){var e,t,o,n;k.zoomLocat||(e=Math.max(0,_xeUtils.default.toNumber(z.marginSize)),t=O(),o=(n=(0,_dom.getDomNode)()).visibleHeight,n=n.visibleWidth,k.zoomLocat={top:t.offsetTop,left:t.offsetLeft,width:t.offsetWidth+(t.style.width?0:1),height:t.offsetHeight+(t.style.height?0:1)},Object.assign(t.style,{top:e+"px",left:e+"px",width:n-2*e+"px",height:o-2*e+"px"}),U())})}function n(){var e=z.duration,c=z.remember,o=z.showFooter,t=k.inited,n=k.visible,i=T.value;return t||(k.inited=!0),n||(c||l(),k.visible=!0,k.contentVisible=!1,B(),allActivedModals.push(N),setTimeout(function(){k.contentVisible=!0,(0,_vue.nextTick)(function(){var e;o&&(e=v.value,t=y.value,(t=e||t)&&t.focus());var t={type:""};m("update:modelValue",!0),S.dispatchEvent("show",t)})},10),i?(-1===msgQueue.indexOf(N)&&msgQueue.push(N),M(),-1!==e&&setTimeout(function(){return C("close")},_xeUtils.default.toNumber(e))):(0,_vue.nextTick)(function(){var e,t,o,n,i,l,u,a,s=z.fullscreen,r=k.firstOpen;c&&r||d().then(function(){setTimeout(d,20)}),r||(k.firstOpen=!0,i=z.id,l=z.remember,u=z.storage,a=z.storageKey,i&&l&&u&&E(a)[i]?(e=z.id,t=z.remember,o=z.storage,n=z.storageKey,e&&t&&o&&((r=E(n)[e])&&(l=O(),a=(u=r.split(","))[0],i=u[1],t=u[2],o=u[3],n=u[4],e=u[5],r=u[6],u=u[7],a&&(l.style.left=a+"px"),i&&(l.style.top=i+"px"),t&&(l.style.width=t+"px"),o&&(l.style.height=o+"px"),n&&e&&(k.zoomLocat={left:n,top:e,width:r,height:u})))):s&&(0,_vue.nextTick)(f))})),(0,_vue.nextTick)()}function p(e){var t=g.value;z.maskClosable&&e.target===t&&C("mask")}function i(e){var t;!(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ESCAPE)||(t=_xeUtils.default.max(allActivedModals,function(e){return e.reactData.modalZindex}))&&setTimeout(function(){t===N&&t.props.escClosable&&C("exit")},10)}function a(){return!!k.zoomLocat}function s(){return(0,_vue.nextTick)().then(function(){var e,t=k.zoomLocat;t&&(e=O(),k.zoomLocat=null,Object.assign(e.style,{top:t.top+"px",left:t.left+"px",width:t.width+"px",height:t.height+"px"}),U())})}function r(){return(k.zoomLocat?s:f)().then(a)}function h(){var t=k.modalZindex;allActivedModals.some(function(e){return e.reactData.visible&&e.reactData.modalZindex>t})&&B()}var _=e.slots,m=e.emit,c=_xeUtils.default.uniqueId(),x=(0,_size.useSize)(z),k=(0,_vue.reactive)({inited:!1,visible:!1,contentVisible:!1,modalTop:0,modalZindex:0,zoomLocat:null,firstOpen:!1}),g=(0,_vue.ref)(),b=(0,_vue.ref)(),v=(0,_vue.ref)(),y=(0,_vue.ref)(),w={refElem:g},N={xID:c,props:z,context:e,reactData:k,getRefMaps:function(){return w}},S={},T=(0,_vue.computed)(function(){return"message"===z.type}),O=function(){return b.value},B=function(){var e=z.zIndex,t=k.modalZindex;e?k.modalZindex=e:t<(0,_utils.getLastZIndex)()&&(k.modalZindex=(0,_utils.nextZIndex)())},M=function(){(0,_vue.nextTick)(function(){var o=0;msgQueue.forEach(function(e){var t=e.getBox();o+=_xeUtils.default.toNumber(e.props.top),e.reactData.modalTop=o,o+=t.clientHeight})})},L=function(){-1<msgQueue.indexOf(N)&&_xeUtils.default.remove(msgQueue,function(e){return e===N}),M()},C=function(e){var t=z.remember,o=z.beforeHideMethod,n=k.visible,i=T.value,l={type:e};return n&&Promise.resolve(o?o(l):null).then(function(e){_xeUtils.default.isError(e)||(i&&L(),k.contentVisible=!1,t||(k.zoomLocat=null),_xeUtils.default.remove(allActivedModals,function(e){return e===N}),S.dispatchEvent("before-hide",l),setTimeout(function(){k.visible=!1,m("update:modelValue",!1),S.dispatchEvent("hide",l)},200))}).catch(function(e){return e}),(0,_vue.nextTick)()},E=function(e){var t=_conf.default.version,e=_xeUtils.default.toStringJSON(localStorage.getItem(e)||"");return e&&e._v===t?e:{_v:t}},U=function(){var e=z.id,t=z.remember,o=z.storage,n=z.storageKey,i=k.zoomLocat;e&&t&&o&&(t=O(),(o=E(n))[e]=[t.style.left,t.style.top,t.style.width,t.style.height].concat(i?[i.left,i.top,i.width,i.height]:[]).map(function(e){return e?_xeUtils.default.toNumber(e):""}).join(","),localStorage.setItem(n,_xeUtils.default.toJSONString(o)))},D=function(e){var t={type:k.zoomLocat?"revert":"max"};return r().then(function(){S.dispatchEvent("zoom",t,e)})},H=function(e){var t,o,i,l,u,a,n=z.remember,s=z.storage,r=k.zoomLocat,c=_xeUtils.default.toNumber(z.marginSize),d=O();r||0!==e.button||(0,_dom.getEventTargetNode)(e,d,"trigger--btn").flag||(e.preventDefault(),t=document.onmousemove,o=document.onmouseup,i=e.clientX-d.offsetLeft,l=e.clientY-d.offsetTop,e=(0,_dom.getDomNode)(),u=e.visibleHeight,a=e.visibleWidth,document.onmousemove=function(e){e.preventDefault();var t=d.offsetWidth,o=d.offsetHeight,n=a-t-c-1,t=u-o-c-1,o=e.clientX-i,e=e.clientY-l;(e=t<e?t:e)<c&&(e=c),d.style.left=(o=(o=n<o?n:o)<c?c:o)+"px",d.style.top=e+"px"},document.onmouseup=function(){document.onmousemove=t,document.onmouseup=o,n&&s&&(0,_vue.nextTick)(function(){U()})})},V=function(e){e.preventDefault();var l=z.remember,u=z.storage,t=(0,_dom.getDomNode)(),a=t.visibleHeight,s=t.visibleWidth,r=_xeUtils.default.toNumber(z.marginSize),c=e.target.getAttribute("type"),d=_xeUtils.default.toNumber(z.minWidth),f=_xeUtils.default.toNumber(z.minHeight),m=s,v=a,p=O(),o=document.onmousemove,n=document.onmouseup,h=p.clientWidth,_=p.clientHeight,x=e.clientX,g=e.clientY,b=p.offsetTop,y=p.offsetLeft,w={type:"resize"};document.onmousemove=function(e){var t,o,n,i;switch(e.preventDefault(),c){case"wl":n=(t=x-e.clientX)+h,r<y-t&&d<n&&(p.style.width=(n<m?n:m)+"px",p.style.left=y-t+"px");break;case"swst":t=x-e.clientX,o=g-e.clientY,n=t+h,i=o+_,r<y-t&&d<n&&(p.style.width=(n<m?n:m)+"px",p.style.left=y-t+"px"),r<b-o&&f<i&&(p.style.height=(i<v?i:v)+"px",p.style.top=b-o+"px");break;case"swlb":t=x-e.clientX,o=e.clientY-g,n=t+h,i=o+_,r<y-t&&d<n&&(p.style.width=(n<m?n:m)+"px",p.style.left=y-t+"px"),b+i+r<a&&f<i&&(p.style.height=(i<v?i:v)+"px");break;case"st":o=g-e.clientY,i=_+o,r<b-o&&f<i&&(p.style.height=(i<v?i:v)+"px",p.style.top=b-o+"px");break;case"wr":t=e.clientX-x,y+(n=t+h)+r<s&&d<n&&(p.style.width=(n<m?n:m)+"px");break;case"sest":t=e.clientX-x,i=(o=g-e.clientY)+_,y+(n=t+h)+r<s&&d<n&&(p.style.width=(n<m?n:m)+"px"),r<b-o&&f<i&&(p.style.height=(i<v?i:v)+"px",p.style.top=b-o+"px");break;case"selb":t=e.clientX-x,i=(o=e.clientY-g)+_,y+(n=t+h)+r<s&&d<n&&(p.style.width=(n<m?n:m)+"px"),b+i+r<a&&f<i&&(p.style.height=(i<v?i:v)+"px");break;case"sb":o=e.clientY-g,b+(i=o+_)+r<a&&f<i&&(p.style.height=(i<v?i:v)+"px")}p.className=p.className.replace(/\s?is--drag/,"")+" is--drag",l&&u&&U(),S.dispatchEvent("zoom",w,e)},document.onmouseup=function(){k.zoomLocat=null,document.onmousemove=o,document.onmouseup=n,setTimeout(function(){p.className=p.className.replace(/\s?is--drag/,"")},50)}},Z=function(){var e=z.slots,t=z.showClose,o=z.showZoom,n=z.title,i=k.zoomLocat,e=_.title||(void 0===e?{}:e).title,n=e?e({$modal:N}):[(0,_vue.h)("span",{class:"vxe-modal--title"},n?(0,_utils.getFuncText)(n):_conf.default.i18n("vxe.alert.title"))];return o&&n.push((0,_vue.h)("i",{class:["vxe-modal--zoom-btn","trigger--btn",i?_conf.default.icon.MODAL_ZOOM_OUT:_conf.default.icon.MODAL_ZOOM_IN],title:_conf.default.i18n("vxe.modal.zoom"+(i?"Out":"In")),onClick:D})),t&&n.push((0,_vue.h)("i",{class:["vxe-modal--close-btn","trigger--btn",_conf.default.icon.MODAL_CLOSE],title:_conf.default.i18n("vxe.modal.close"),onClick:u})),n},q=function(){var e=[];return"confirm"===z.type&&e.push((0,_vue.h)(_button.default,{ref:y,content:z.cancelButtonText||_conf.default.i18n("vxe.button.cancel"),onClick:o})),e.push((0,_vue.h)(_button.default,{ref:v,status:"primary",content:z.confirmButtonText||_conf.default.i18n("vxe.button.confirm"),onClick:t})),e},S={dispatchEvent:function(e,t,o){m(e,Object.assign({$modal:N,$event:o},t))},open:n,close:function(){return C("close")},getBox:O,getPosition:function(){if(!T.value){var e=O();if(e)return{top:e.offsetTop,left:e.offsetLeft}}return null},setPosition:function(e,t){var o;return T.value||(o=O(),_xeUtils.default.isNumber(e)&&(o.style.top=e+"px"),_xeUtils.default.isNumber(t)&&(o.style.left=t+"px")),(0,_vue.nextTick)()},isMaximized:a,zoom:r,maximize:f,revert:s};Object.assign(N,S),(0,_vue.watch)(function(){return z.width},l),(0,_vue.watch)(function(){return z.height},l),(0,_vue.watch)(function(){return z.modelValue},function(e){e?n():C("model")}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){z.storage&&!z.id&&(0,_log.errLog)("vxe.error.reqProp",["modal.id"]),z.modelValue&&n(),l()}),z.escClosable&&_event.GlobalEvent.on(N,"keydown",i)}),(0,_vue.onUnmounted)(function(){_event.GlobalEvent.off(N,"keydown"),L()});return N.renderVN=function(){var e=z.className,t=z.type,o=z.animat,n=z.loading,i=z.status,l=z.lockScroll,u=z.lockView,a=z.mask,s=z.resize,r=k.inited,c=k.zoomLocat,d=k.modalTop,f=k.contentVisible,m=k.visible,v=x.value;return(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!z.transfer||!r},[(0,_vue.h)("div",{ref:g,class:["vxe-modal--wrapper","type--"+t,e||"",((e={})["size--"+v]=v,e["status--"+i]=i,e["is--animat"]=o,e["lock--scroll"]=l,e["lock--view"]=u,e["is--resize"]=s,e["is--mask"]=a,e["is--maximize"]=c,e["is--visible"]=f,e["is--active"]=m,e["is--loading"]=n,e)],style:{zIndex:k.modalZindex,top:d?d+"px":null},onClick:p},[(0,_vue.h)("div",{ref:b,class:"vxe-modal--box",onMousedown:h},(c=z.slots,f=z.showZoom,m=z.draggable,n=T.value,e=_.header||(void 0===c?{}:c).header,d=[],z.showHeader&&(c={},m&&(c.onMousedown=H),f&&z.dblclickZoom&&"modal"===z.type&&(c.onDblclick=D),d.push((0,_vue.h)("div",__assign({class:["vxe-modal--header",{"is--drag":m,"is--ellipsis":!n&&z.showTitleOverflow}]},c),e?!k.inited||z.destroyOnClose&&!k.visible?[]:e({$modal:N}):Z()))),d.concat((m=z.slots,n=z.status,c=z.message,e=z.content||c,d=T.value,c=_.default||(void 0===m?{}:m).default,m=[],n&&m.push((0,_vue.h)("div",{class:"vxe-modal--status-wrapper"},[(0,_vue.h)("i",{class:["vxe-modal--status-icon",z.iconStatus||_conf.default.icon[("MODAL_"+n).toLocaleUpperCase()]]})])),m.push((0,_vue.h)("div",{class:"vxe-modal--content"},c?!k.inited||z.destroyOnClose&&!k.visible?[]:c({$modal:N}):(0,_utils.getFuncText)(e))),d||m.push((0,_vue.h)("div",{class:["vxe-loading",{"is--visible":z.loading}]},[(0,_vue.h)("div",{class:"vxe-loading--spinner"})])),[(0,_vue.h)("div",{class:"vxe-modal--body"},m)]),(e=z.slots,d=T.value,m=_.footer||(void 0===e?{}:e).footer,e=[],z.showFooter&&e.push((0,_vue.h)("div",{class:"vxe-modal--footer"},m?!k.inited||z.destroyOnClose&&!k.visible?[]:m({$modal:N}):q())),!d&&z.resize&&e.push((0,_vue.h)("span",{class:"vxe-modal--resize"},["wl","wr","swst","sest","st","swlb","selb","sb"].map(function(e){return(0,_vue.h)("span",{class:e+"-resize",type:e,onMousedown:V})}))),e))))])])},N},render:function(){return this.renderVN()}});exports.default=_default2;