"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var htmlCellElem,_vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=require("../../v-x-e-table"),_util=require("../../table/src/util"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_util2=require("./util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var csvBOM="\ufeff",enterSymbol="\r\n";function defaultFilterExportColumn(e){return e.property||-1<["seq","checkbox","radio"].indexOf(e.type)}var getConvertColumns=function t(e){var r=[];return e.forEach(function(e){e.childNodes&&e.childNodes.length?(r.push(e),r.push.apply(r,t(e.childNodes))):r.push(e)}),r},convertToRows=function(e){function o(t,e){var r;e&&(t._level=e._level+1,n<t._level&&(n=t._level)),t.childNodes&&t.childNodes.length?(r=0,t.childNodes.forEach(function(e){o(e,t),r+=e._colSpan}),t._colSpan=r):t._colSpan=1}var n=1;e.forEach(function(e){e._level=1,o(e)});for(var t=[],r=0;r<n;r++)t.push([]);return getConvertColumns(e).forEach(function(e){e.childNodes&&e.childNodes.length?e._rowSpan=1:e._rowSpan=n-e._level+1,t[e._level-1].push(e)}),t};function toTableBorder(e){return!0===e?"full":e||"default"}function getBooleanValue(e){return"TRUE"===e||"true"===e||!0===e}function getHeaderTitle(e,t){return(e.original?t.property:t.getTitle())||""}function getFooterData(e,t){var r=e.footerFilterMethod;return r?t.filter(function(e,t){return r({items:e,$rowIndex:t})}):t}function getCsvCellTypeLabel(e,t){if(t){if("seq"===e.type)return"\t"+t;switch(e.cellType){case"string":if(!isNaN(t))return"\t"+t;break;case"number":break;default:if(12<=t.length&&!isNaN(t))return"\t"+t}}return t}function toTxtCellLabel(e){return/[",\s\n]/.test(e)?'"'+e.replace(/"/g,'""')+'"':e}function getElementsByTagName(e,t){return e.getElementsByTagName(t)}function getTxtCellKey(e){return"#"+e+"@"+_xeUtils.default.uniqueId()}function replaceTxtCell(e,t){return e.replace(/#\d+@\d+/g,function(e){return _xeUtils.default.hasOwnProp(t,e)?t[e]:e})}function getTxtCellValue(e,t){return replaceTxtCell(e,t).replace(/^"+$/g,function(e){return'"'.repeat(Math.ceil(e.length/2))})}function parseCsvAndTxt(e,t,o){var n,l,t=t.split(enterSymbol),a=[],i=[];return t.length&&(n={},l=Date.now(),t.forEach(function(e){var r;e&&(r={},e=(e=e.replace(/("")|(\n)/g,function(e,t){var r=getTxtCellKey(l);return n[r]=t?'"':"\n",r}).replace(/"(.*?)"/g,function(e,t){var r=getTxtCellKey(l);return n[r]=replaceTxtCell(t,n),r})).split(o),i.length?(e.forEach(function(e,t){t<i.length&&(r[i[t]]=getTxtCellValue(e.trim(),n))}),a.push(r)):i=e.map(function(e){return getTxtCellValue(e.trim(),n)}))})),{fields:i,rows:a}}function parseCsv(e,t){return parseCsvAndTxt(e,t,",")}function parseTxt(e,t){return parseCsvAndTxt(e,t,"\t")}function parseHTML(e,t){var r=getElementsByTagName((new DOMParser).parseFromString(t,"text/html"),"body"),o=[],n=[];return r.length&&(!(t=getElementsByTagName(r[0],"table")).length||(r=getElementsByTagName(t[0],"thead")).length&&(_xeUtils.default.arrayEach(getElementsByTagName(r[0],"tr"),function(e){_xeUtils.default.arrayEach(getElementsByTagName(e,"th"),function(e){n.push(e.textContent)})}),(t=getElementsByTagName(t[0],"tbody")).length&&_xeUtils.default.arrayEach(getElementsByTagName(t[0],"tr"),function(e){var r={};_xeUtils.default.arrayEach(getElementsByTagName(e,"td"),function(e,t){n[t]&&(r[n[t]]=e.textContent||"")}),o.push(r)}))),{fields:n,rows:o}}function parseXML(e,t){var t=getElementsByTagName((new DOMParser).parseFromString(t,"application/xml"),"Worksheet"),o=[],n=[];return t.length&&(!(t=getElementsByTagName(t[0],"Table")).length||(t=getElementsByTagName(t[0],"Row")).length&&(_xeUtils.default.arrayEach(getElementsByTagName(t[0],"Cell"),function(e){n.push(e.textContent)}),_xeUtils.default.arrayEach(t,function(e,t){var r;t&&(r={},e=getElementsByTagName(e,"Cell"),_xeUtils.default.arrayEach(e,function(e,t){n[t]&&(r[n[t]]=e.textContent)}),o.push(r))}))),{fields:n,rows:o}}function clearColumnConvert(e){_xeUtils.default.eachTree(e,function(e){delete e._level,delete e._colSpan,delete e._rowSpan,delete e._children,delete e.childNodes},{children:"children"})}function checkImportData(e,t){var r=[];return e.forEach(function(e){e=e.property;e&&r.push(e)}),t.some(function(e){return-1<r.indexOf(e)})}var tableExportMethodKeys=["exportData","importByFile","importData","saveFile","readFile","print","openImport","openExport","openPrint"],tableExportHook={setupTable:function(w){function v(e,t,r,o){var n=l.value.seqMethod||r.seqMethod;return n?n({row:e,rowIndex:w.getRowIndex(e),$rowIndex:t,column:r,columnIndex:w.getColumnIndex(r),$columnIndex:o}):w.getRowSeq(e)}function g(e){return _xeUtils.default.isBoolean(e)?e?"TRUE":"FALSE":e}function C(e,t,r){var o=r.editRender||r.cellRender,n=r.footerExportMethod;n||!o||!o.name||(l=_vXETable.VXETable.renderer.get(o.name))&&(n=l.footerExportMethod);var l=w.getVTColumnIndex(r);return n?n({$table:w,items:t,itemIndex:l,_columnIndex:l,column:r,options:e}):_xeUtils.default.toValueString(t[l])}function k(e,t,r){return e=e[t],t=_xeUtils.default.isUndefined(e)||_xeUtils.default.isNull(e)?r:e,r="title"===t||(!0===t||"tooltip"===t)||"ellipsis"===t,e=j.scrollXLoad,t=j.scrollYLoad,r=(e||t)&&!r?!0:r}function b(a){var i=a.remote,s=a.columns,c=a.colgroups,d=a.exportMethod,t=a.afterExportMethod;return new Promise(function(e){var t,r,o,n,l;i?(l={options:a,$table:w,$grid:T},e(d?d(l):l)):(o=(r=a).columns,n=r.dataFilterMethod,l=r.data,n&&(l=l.filter(function(e,t){return n({row:e,$rowIndex:t})})),t=u(r,o,l),e(w.preventEvent(null,"event.export",{options:a,columns:s,colgroups:c,datas:t},function(){return function(e,t){var r=e.filename,o=e.type;if(!e.download){var n=(0,_util2.getExportBlobByContent)(t,e);return Promise.resolve({type:o,content:t,blob:n})}(0,_util2.saveLocalFile)({filename:r,type:o,content:t}).then(function(){!1!==e.message&&("development"===process.env.NODE_ENV&&(_vXETable.VXETable.modal||(0,_log.errLog)("vxe.error.reqModule",["Modal"])),_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.table.expSuccess"),status:"success"}))})}(a,function(e,t,r){if(t.length)switch(e.type){case"csv":return p(e,t,r);case"txt":return f(e,t,r);case"html":return h(e,t,r);case"xml":return m(e,t,r)}return""}(a,s,t))})))}).then(function(e){return clearColumnConvert(s),a.print||t&&t({status:!0,options:a,$table:w,$grid:T}),Object.assign({status:!0},e)}).catch(function(){clearColumnConvert(s),a.print||t&&t({status:!1,options:a,$table:w,$grid:T});return Promise.reject({status:!1})})}function n(a,i){var s=i.importMethod,t=i.afterImportMethod,e=(0,_utils.parseFile)(a),c=e.type,d=e.filename;return s||_xeUtils.default.includes(_vXETable.VXETable.config.importTypes,c)?new Promise(function(t,r){function e(e){t(e),_._importResolve=null,_._importReject=null}function o(e){r(e),_._importResolve=null,_._importReject=null}var n,l;_._importResolve=e,_._importReject=o,window.FileReader?(n=Object.assign({mode:"insert"},i,{type:c,filename:d})).remote?s?Promise.resolve(s({file:a,options:n,$table:w})).then(function(){e({status:!0})}).catch(function(){e({status:!0})}):e({status:!0}):(l=_.tableFullColumn,w.preventEvent(null,"event.import",{file:a,options:n,columns:l},function(){var e=new FileReader;e.onerror=function(){(0,_log.errLog)("vxe.error.notType",[c]),o({status:!1})},e.onload=function(e){!function(e,t){var r=_.tableFullColumn,o=_._importResolve,n=_._importReject,l={fields:[],rows:[]};switch(t.type){case"csv":l=parseCsv(r,e);break;case"txt":l=parseTxt(r,e);break;case"html":l=parseHTML(r,e);break;case"xml":l=parseXML(r,e)}var a=l.fields,i=l.rows;checkImportData(r,a)?w.createData(i).then(function(e){e="insert"===t.mode?w.insert(e):w.reloadData(e);return!1!==t.message&&("development"===process.env.NODE_ENV&&(_vXETable.VXETable.modal||(0,_log.errLog)("vxe.error.reqModule",["Modal"])),_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.table.impSuccess",[i.length]),status:"success"})),e.then(function(){o&&o({status:!0})})}):!1!==t.message&&("development"===process.env.NODE_ENV&&(_vXETable.VXETable.modal||(0,_log.errLog)("vxe.error.reqModule",["Modal"])),_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.error.impFields"),status:"error"}),n&&n({status:!1}))}(e.target.result,n)},e.readAsText(a,n.encoding||"UTF-8")})):("development"===process.env.NODE_ENV&&(0,_log.errLog)("vxe.error.notExp"),e({status:!0}))}).then(function(){t&&t({status:!0,options:i,$table:w})}).catch(function(e){return t&&t({status:!1,options:i,$table:w}),Promise.reject(e)}):(!1!==i.message&&("development"===process.env.NODE_ENV&&(_vXETable.VXETable.modal||(0,_log.errLog)("vxe.error.reqModule",["Modal"])),_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.error.notType",[c]),status:"error"})),Promise.reject({status:!1}))}function r(e,t){var r=N.treeConfig,o=N.showHeader,n=N.showFooter,l=j.initStore,a=j.mergeList,i=j.isGroup,s=j.footerTableData,c=j.exportStore,d=j.exportParams,u=_.collectColumn,p=r,f=x.value,h=w.getCheckboxRecords(),r=!!s.length,s=!p&&a.length,o=(a=Object.assign({message:!0,isHeader:o,isFooter:n},e)).types||_vXETable.VXETable.config.exportTypes,n=a.modes,m=f.checkMethod,e=u.slice(0),v=a.columns,f=o.map(function(e){return{value:e,label:"vxe.export.types."+e}}),u=n.map(function(e){return{value:e,label:"vxe.export.modes."+e}});return _xeUtils.default.eachTree(e,function(o,e,t,r,n){(o.children&&o.children.length||defaultFilterExportColumn(o))&&(o.checked=v?v.some(function(e){if((0,_util.isColumnInfo)(e))return o===e;if(_xeUtils.default.isString(e))return o.field===e;var t=e.id||e.colId,r=e.type,e=e.property||e.field;return t?o.id===t:e&&r?o.property===e&&o.type===r:e?o.property===e:r?o.type===r:void 0}):o.visible,o.halfChecked=!1,o.disabled=n&&n.disabled||!!m&&!m({column:o}))}),Object.assign(c,{columns:e,typeList:f,modeList:u,hasFooter:r,hasMerge:s,hasTree:p,isPrint:t,hasColgroup:i,visible:!0}),l.export||Object.assign(d,{mode:h.length?"selected":"current"},a),-1===n.indexOf(d.mode)&&(d.mode=n[0]),-1===o.indexOf(d.type)&&(d.type=o[0]),l.export=!0,(0,_vue.nextTick)()}var N=w.props,j=w.reactData,_=w.internalData,e=w.getComputeMaps(),D=e.computeTreeOpts,o=e.computePrintOpts,y=e.computeExportOpts,i=e.computeImportOpts,x=e.computeCustomOpts,l=e.computeSeqOpts,a=e.computeRadioOpts,s=e.computeCheckboxOpts,T=(0,_vue.inject)("$xegrid",null),u=function(d,n,e){var l=d.isAllExpand,u=d.mode,t=N.treeConfig,p=a.value,f=s.value,r=D.value;if(htmlCellElem=htmlCellElem||document.createElement("div"),t){var h=[],m=new Map;return _xeUtils.default.eachTree(e,function(e,a,t,i,r,o){var s,c=e._row||e,e=r&&r._row?r._row:r;(l||!e||m.has(e)&&w.isTreeExpandByRow(e))&&(r=c,e=D.value,e=r[e.children]&&r[e.children].length,s={_row:c,_level:o.length-1,_hasChild:e,_expand:e&&w.isTreeExpandByRow(c)},n.forEach(function(e,t){var r,o="",n=e.editRender||e.cellRender,l=e.exportMethod;if(l||!n||!n.name||(n=_vXETable.VXETable.renderer.get(n.name))&&(l=n.exportMethod),l)o=l({$table:w,row:c,column:e,options:d});else switch(e.type){case"seq":o="all"===u?i.map(function(e,t){return t%2==0?Number(e)+1:"."}).join(""):v(c,a,e,t);break;case"checkbox":o=g(w.isCheckedByCheckboxRow(c)),s._checkboxLabel=f.labelField?_xeUtils.default.get(c,f.labelField):"",s._checkboxDisabled=f.checkMethod&&!f.checkMethod({row:c});break;case"radio":o=g(w.isCheckedByRadioRow(c)),s._radioLabel=p.labelField?_xeUtils.default.get(c,p.labelField):"",s._radioDisabled=p.checkMethod&&!p.checkMethod({row:c});break;default:d.original?o=(0,_util.getCellValue)(c,e):(o=w.getCellLabel(c,e),"html"===e.type?(htmlCellElem.innerHTML=o,o=htmlCellElem.innerText.trim()):(r=w.getCell(c,e))&&(o=r.innerText.trim()))}s[e.id]=_xeUtils.default.toValueString(o)}),m.set(c,1),h.push(Object.assign(s,c)))},r),h}return e.map(function(a,i){var s={_row:a};return n.forEach(function(e,t){var r,o="",n=e.editRender||e.cellRender,l=e.exportMethod;if(l||!n||!n.name||(n=_vXETable.VXETable.renderer.get(n.name))&&(l=n.exportMethod),l)o=l({$table:w,row:a,column:e,options:d});else switch(e.type){case"seq":o="all"===u?i+1:v(a,i,e,t);break;case"checkbox":o=g(w.isCheckedByCheckboxRow(a)),s._checkboxLabel=f.labelField?_xeUtils.default.get(a,f.labelField):"",s._checkboxDisabled=f.checkMethod&&!f.checkMethod({row:a});break;case"radio":o=g(w.isCheckedByRadioRow(a)),s._radioLabel=p.labelField?_xeUtils.default.get(a,p.labelField):"",s._radioDisabled=p.checkMethod&&!p.checkMethod({row:a});break;default:d.original?o=(0,_util.getCellValue)(a,e):(o=w.getCellLabel(a,e),"html"===e.type?(htmlCellElem.innerHTML=o,o=htmlCellElem.innerText.trim()):(r=w.getCell(a,e))&&(o=r.innerText.trim()))}s[e.id]=_xeUtils.default.toValueString(o)}),s})},p=function(r,e,t){var o=csvBOM;return r.isHeader&&(o+=e.map(function(e){return toTxtCellLabel(getHeaderTitle(r,e))}).join(",")+enterSymbol),t.forEach(function(t){o+=e.map(function(e){return toTxtCellLabel(getCsvCellTypeLabel(e,t[e.id]))}).join(",")+enterSymbol}),r.isFooter&&(t=j.footerTableData,getFooterData(r,t).forEach(function(t){o+=e.map(function(e){return toTxtCellLabel(C(r,t,e))}).join(",")+enterSymbol})),o},f=function(r,e,t){var o="";return r.isHeader&&(o+=e.map(function(e){return toTxtCellLabel(getHeaderTitle(r,e))}).join("\t")+enterSymbol),t.forEach(function(t){o+=e.map(function(e){return toTxtCellLabel(t[e.id])}).join("\t")+enterSymbol}),r.isFooter&&(t=j.footerTableData,getFooterData(r,t).forEach(function(t){o+=e.map(function(e){return toTxtCellLabel(C(r,t,e))}).join(",")+enterSymbol})),o},h=function(i,e,t){var c=N.id,r=N.border,o=N.treeConfig,s=N.headerAlign,d=N.align,l=N.footerAlign,u=N.showOverflow,p=N.showHeaderOverflow,f=j.isAllSelected,n=j.isIndeterminate,h=j.mergeList,a=D.value,m=i.print,v=i.isHeader,g=i.isFooter,x=i.isColgroup,b=i.isMerge,_=i.colgroups,y=i.original,T="check-all",E=['<table class="'+["vxe-table","border--"+toTableBorder(r),m?"is--print":"",v?"is--header":""].filter(function(e){return e}).join(" ")+'" border="0" cellspacing="0" cellpadding="0">',"<colgroup>"+e.map(function(e){return'<col style="width:'+e.renderWidth+'px">'}).join("")+"</colgroup>"];return v&&(E.push("<thead>"),x&&!y?_.forEach(function(e){E.push("<tr>"+e.map(function(t){var e=t.headerAlign||t.align||s||d,r=k(t,"showHeaderOverflow",p)?["col--ellipsis"]:[],o=getHeaderTitle(i,t),n=0,l=0;_xeUtils.default.eachTree([t],function(e){e.childNodes&&t.childNodes.length||l++,n+=e.renderWidth},{children:"childNodes"});var a=n-l;return e&&r.push("col--"+e),"checkbox"===t.type?'<th class="'+r.join(" ")+'" colspan="'+t._colSpan+'" rowspan="'+t._rowSpan+'"><div '+(m?"":'style="width: '+a+'px"')+'><input type="checkbox" class="'+T+'" '+(f?"checked":"")+"><span>"+o+"</span></div></th>":'<th class="'+r.join(" ")+'" colspan="'+t._colSpan+'" rowspan="'+t._rowSpan+'" title="'+o+'"><div '+(m?"":'style="width: '+a+'px"')+"><span>"+(0,_utils.formatText)(o,!0)+"</span></div></th>"}).join("")+"</tr>")}):E.push("<tr>"+e.map(function(e){var t=e.headerAlign||e.align||s||d,r=k(e,"showHeaderOverflow",p)?["col--ellipsis"]:[],o=getHeaderTitle(i,e);return t&&r.push("col--"+t),"checkbox"===e.type?'<th class="'+r.join(" ")+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+'><input type="checkbox" class="'+T+'" '+(f?"checked":"")+"><span>"+o+"</span></div></th>":'<th class="'+r.join(" ")+'" title="'+o+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+"><span>"+(0,_utils.formatText)(o,!0)+"</span></div></th>"}).join("")+"</tr>"),E.push("</thead>")),t.length&&(E.push("<tbody>"),o?t.forEach(function(n){E.push("<tr>"+e.map(function(e){var t=e.align||d,r=k(e,"showOverflow",u)?["col--ellipsis"]:[],o=n[e.id];if(t&&r.push("col--"+t),e.treeNode){t="";return n._hasChild&&(t='<i class="'+(n._expand?"vxe-table--tree-fold-icon":"vxe-table--tree-unfold-icon")+'"></i>'),r.push("vxe-table--tree-node"),"radio"===e.type?'<td class="'+r.join(" ")+'" title="'+o+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+'><div class="vxe-table--tree-node-wrapper" style="padding-left: '+n._level*a.indent+'px"><div class="vxe-table--tree-icon-wrapper">'+t+'</div><div class="vxe-table--tree-cell"><input type="radio" name="radio_'+c+'" '+(n._radioDisabled?"disabled ":"")+(getBooleanValue(o)?"checked":"")+"><span>"+n._radioLabel+"</span></div></div></div></td>":"checkbox"===e.type?'<td class="'+r.join(" ")+'" title="'+o+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+'><div class="vxe-table--tree-node-wrapper" style="padding-left: '+n._level*a.indent+'px"><div class="vxe-table--tree-icon-wrapper">'+t+'</div><div class="vxe-table--tree-cell"><input type="checkbox" '+(n._checkboxDisabled?"disabled ":"")+(getBooleanValue(o)?"checked":"")+"><span>"+n._checkboxLabel+"</span></div></div></div></td>":'<td class="'+r.join(" ")+'" title="'+o+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+'><div class="vxe-table--tree-node-wrapper" style="padding-left: '+n._level*a.indent+'px"><div class="vxe-table--tree-icon-wrapper">'+t+'</div><div class="vxe-table--tree-cell">'+o+"</div></div></div></td>"}return"radio"===e.type?'<td class="'+r.join(" ")+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+'><input type="radio" name="radio_'+c+'" '+(n._radioDisabled?"disabled ":"")+(getBooleanValue(o)?"checked":"")+"><span>"+n._radioLabel+"</span></div></td>":"checkbox"===e.type?'<td class="'+r.join(" ")+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+'><input type="checkbox" '+(n._checkboxDisabled?"disabled ":"")+(getBooleanValue(o)?"checked":"")+"><span>"+n._checkboxLabel+"</span></div></td>":'<td class="'+r.join(" ")+'" title="'+o+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+">"+(0,_utils.formatText)(o,!0)+"</div></td>"}).join("")+"</tr>")}):t.forEach(function(s){E.push("<tr>"+e.map(function(e){var t=e.align||d,r=k(e,"showOverflow",u)?["col--ellipsis"]:[],o=s[e.id],n=1,l=1;if(b&&h.length){var a=w.getVTRowIndex(s._row),i=w.getVTColumnIndex(e),a=(0,_util.mergeBodyMethod)(h,a,i);if(a){i=a.rowspan,a=a.colspan;if(!i||!a)return"";1<i&&(n=i),1<a&&(l=a)}}return t&&r.push("col--"+t),"radio"===e.type?'<td class="'+r.join(" ")+'" rowspan="'+n+'" colspan="'+l+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+'><input type="radio" name="radio_'+c+'" '+(s._radioDisabled?"disabled ":"")+(getBooleanValue(o)?"checked":"")+"><span>"+s._radioLabel+"</span></div></td>":"checkbox"===e.type?'<td class="'+r.join(" ")+'" rowspan="'+n+'" colspan="'+l+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+'><input type="checkbox" '+(s._checkboxDisabled?"disabled ":"")+(getBooleanValue(o)?"checked":"")+"><span>"+s._checkboxLabel+"</span></div></td>":'<td class="'+r.join(" ")+'" rowspan="'+n+'" colspan="'+l+'" title="'+o+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+">"+(0,_utils.formatText)(o,!0)+"</div></td>"}).join("")+"</tr>")}),E.push("</tbody>")),g&&(g=j.footerTableData,(g=getFooterData(i,g)).length&&(E.push("<tfoot>"),g.forEach(function(n){E.push("<tr>"+e.map(function(e){var t=e.footerAlign||e.align||l||d,r=k(e,"showOverflow",u)?["col--ellipsis"]:[],o=C(i,n,e);return t&&r.push("col--"+t),'<td class="'+r.join(" ")+'" title="'+o+'"><div '+(m?"":'style="width: '+e.renderWidth+'px"')+">"+(0,_utils.formatText)(o,!0)+"</div></td>"}).join("")+"</tr>")}),E.push("</tfoot>"))),E.push("</table>",!f&&n?'<script>(function(){var a=document.querySelector(".'+T+'");if(a){a.indeterminate=true}})()<\/script>':""),m?E.join(""):(0,_util2.createHtmlPage)(i,E.join(""))},m=function(r,e,t){var o=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",'<Worksheet ss:Name="'+r.sheetName+'">',"<Table>",e.map(function(e){return'<Column ss:Width="'+e.renderWidth+'"/>'}).join("")].join("");return r.isHeader&&(o+="<Row>"+e.map(function(e){return'<Cell><Data ss:Type="String">'+getHeaderTitle(r,e)+"</Data></Cell>"}).join("")+"</Row>"),t.forEach(function(t){o+="<Row>"+e.map(function(e){return'<Cell><Data ss:Type="String">'+t[e.id]+"</Data></Cell>"}).join("")+"</Row>"}),r.isFooter&&(t=j.footerTableData,getFooterData(r,t).forEach(function(t){o+="<Row>"+e.map(function(e){return'<Cell><Data ss:Type="String">'+C(r,t,e)+"</Data></Cell>"}).join("")+"</Row>"})),o+"</Table></Worksheet></Workbook>"},c={exportData:function(e){var t=N.treeConfig,r=j.isGroup,o=j.tableGroupColumn,l=_.tableFullColumn,n=_.afterFullData,a=y.value,i=D.value,s=Object.assign({isHeader:!0,isFooter:!0,isColgroup:!0,download:!0,type:"csv",mode:"current"},a,{print:!1},e),c=s.type,d=s.mode,u=s.columns,p=s.original,a=s.beforeExportMethod,e=[],u=u&&u.length?u:null,f=s.columnFilterMethod;u||f||(f=p?function(e){return e.column.property}:function(e){return defaultFilterExportColumn(e.column)});var e=u?_xeUtils.default.searchTree(_xeUtils.default.mapTree(u,function(e){var t,r,o,n;if(e)return(0,_util.isColumnInfo)(e)?t=e:_xeUtils.default.isString(e)?t=w.getColumnByField(e):(r=e.id||e.colId,o=e.type,n=e.property||e.field,r?t=w.getColumnById(r):n&&o?t=l.find(function(e){return e.property===n&&e.type===o}):n?t=w.getColumnByField(n):o&&(t=l.find(function(e){return e.type===o}))),t||{}},{children:"childNodes",mapChildren:"_children"}),function(e,t){return(0,_util.isColumnInfo)(e)&&(!f||f({column:e,$columnIndex:t}))},{children:"_children",mapChildren:"childNodes",original:!0}):_xeUtils.default.searchTree(r?o:l,function(e,t){return e.visible&&(!f||f({column:e,$columnIndex:t}))},{children:"children",mapChildren:"childNodes",original:!0}),h=[];if(_xeUtils.default.eachTree(e,function(e){e.children&&e.children.length||h.push(e)},{children:"childNodes"}),s.columns=h,s.colgroups=convertToRows(e),s.filename||(s.filename=_conf.default.i18n(s.original?"vxe.table.expOriginFilename":"vxe.table.expFilename",[_xeUtils.default.toDateString(Date.now(),"yyyyMMddHHmmss")])),s.sheetName||(s.sheetName=document.title),!s.exportMethod&&!_xeUtils.default.includes(_vXETable.VXETable.config.exportTypes,c)){"development"===process.env.NODE_ENV&&(0,_log.errLog)("vxe.error.notType",[c]);return Promise.reject({status:!1})}if(s.print||a&&a({options:s,$table:w,$grid:T}),!s.data)if(s.data=n,"selected"===d){var m=w.getCheckboxRecords();-1<["html","pdf"].indexOf(c)&&t?s.data=_xeUtils.default.searchTree(w.getTableData().fullData,function(e){return-1<w.findRowIndexOf(m,e)},Object.assign({},i,{data:"_row"})):s.data=m}else if("all"===d&&("development"===process.env.NODE_ENV&&(T||(0,_log.warnLog)("vxe.error.errProp",["all","mode=current,selected"])),T&&!s.remote)){var c=T.reactData,t=T.getComputeMaps().computeProxyOpts.value,i=t.beforeQueryAll,v=t.afterQueryAll,d=t.ajax,t=t.props,g=void 0===t?{}:t,d=(void 0===d?{}:d).queryAll;if("development"===process.env.NODE_ENV&&(d||(0,_log.warnLog)("vxe.error.notFunc",["proxy-config.ajax.queryAll"])),d){var x={$table:w,$grid:T,sort:c.sortData,filters:c.filterData,form:c.formData,target:d,options:s};return Promise.resolve((i||d)(x)).catch(function(e){return e}).then(function(e){return s.data=(g.list?_xeUtils.default.get(e,g.list):e)||[],v&&v(x),b(s)})}}return b(s)},importByFile:function(e,t){var r=Object.assign({},t),t=r.beforeImportMethod;return t&&t({options:r,$table:w}),n(e,r)},importData:function(e){var t=i.value,r=Object.assign({types:_vXETable.VXETable.config.importTypes},t,e),e=r.beforeImportMethod,o=r.afterImportMethod;return e&&e({options:r,$table:w}),(0,_util2.readLocalFile)(r).catch(function(e){return o&&o({status:!1,options:r,$table:w}),Promise.reject(e)}).then(function(e){e=e.file;return n(e,r)})},saveFile:function(e){return(0,_util2.saveLocalFile)(e)},readFile:function(e){return(0,_util2.readLocalFile)(e)},print:function(e){var t=o.value,r=Object.assign({original:!1},t,e,{type:"html",download:!1,remote:!1,print:!0});return r.sheetName||(r.sheetName=document.title),new Promise(function(e){r.content?e((0,_util2.handlePrint)(w,r,r.content)):e(c.exportData(r).then(function(e){e=e.content;return(0,_util2.handlePrint)(w,r,e)}))})},openImport:function(e){var t=N.treeConfig,r=N.importConfig,o=j.initStore,n=j.importStore,l=j.importParams,a=i.value,e=Object.assign({mode:"insert",message:!0,types:_vXETable.VXETable.config.importTypes},e,a),a=e.types;!t?(r||(0,_log.errLog)("vxe.error.reqProp",["import-config"]),r=a.map(function(e){return{value:e,label:"vxe.export.types."+e}}),a=e.modes.map(function(e){return{value:e,label:"vxe.import.modes."+e}}),Object.assign(n,{file:null,type:"",filename:"",modeList:a,typeList:r,visible:!0}),Object.assign(l,e),o.import=!0):e.message&&_vXETable.VXETable.modal.message({content:_conf.default.i18n("vxe.error.treeNotImp"),status:"error"})},openExport:function(e){var t=y.value;"development"===process.env.NODE_ENV&&(N.exportConfig||(0,_log.errLog)("vxe.error.reqProp",["export-config"])),r(Object.assign({},t,e))},openPrint:function(e){var t=o.value;"development"===process.env.NODE_ENV&&(N.printConfig||(0,_log.errLog)("vxe.error.reqProp",["print-config"])),r(Object.assign({},t,e),!0)}};return c},setupGrid:function(e){return e.extendTableMethods(tableExportMethodKeys)}},_default=tableExportHook;exports.default=_default;