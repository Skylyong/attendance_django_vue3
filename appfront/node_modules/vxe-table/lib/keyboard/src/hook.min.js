"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function getTargetOffset(e,t){var o,l,n=0,r=0,a=!_dom.browse.firefox&&(0,_dom.hasClass)(e,"vxe-checkbox--label");for(a&&(o=getComputedStyle(e),n-=_xeUtils.default.toNumber(o.paddingTop),r-=_xeUtils.default.toNumber(o.paddingLeft));e&&e!==t;)n+=e.offsetTop,r+=e.offsetLeft,e=e.offsetParent,a&&(l=getComputedStyle(e),n-=_xeUtils.default.toNumber(l.paddingTop),r-=_xeUtils.default.toNumber(l.paddingLeft));return{offsetTop:n,offsetLeft:r}}var tableKeyboardHook={setupTable:function(y){var f=y.props,k=y.reactData,H=y.internalData,E=y.getRefMaps().refElem,e=y.getComputeMaps(),g=e.computeEditOpts,c=e.computeCheckboxOpts,i=e.computeMouseOpts,s=e.computeTreeOpts;function d(e,u){var t,o,c,i,s,d,l,n,f,g,m,h,p,v,x,w,b,T,C,R,_,I,r,a=u.column,M=u.cell;"checkbox"===a.type&&(t=E.value,o=H.elemStore,c=e.clientX,i=e.clientY,s=o[(a.fixed||"main")+"-body-wrapper"]||o["main-body-wrapper"],d=s.querySelector(".vxe-table--checkbox-range"),l=document.onmousemove,n=document.onmouseup,f=M.parentNode,g=y.getCheckboxRecords(),m=[],h=1,M=getTargetOffset(e.target,s),p=M.offsetTop+e.offsetY,v=M.offsetLeft+e.offsetX,x=s.scrollTop,w=f.offsetHeight,b=null,C=1,R=function(e,t){y.dispatchEvent("checkbox-range-"+e,{records:y.getCheckboxRecords(),reserves:y.getCheckboxReserveRecords()},t)},_=function(e){var t=e.clientX,o=e.clientY,l=t-c,n=o-i+(s.scrollTop-x),r=Math.abs(n),a=Math.abs(l),t=p,o=v;n<h?(t+=n)<h&&(t=h,r=p):r=Math.min(r,s.scrollHeight-p-h),l<h?(o+=l,v<a&&(o=h,a=v)):a=Math.min(a,s.clientWidth-v-h),d.style.height=r+"px",d.style.width=a+"px",d.style.left=o+"px",d.style.top=t+"px",d.style.display="block";n=function(e,t,o){var l=0,n=[],r=0<o,a=0<o?o:Math.abs(o)+t.offsetHeight,u=k.scrollYLoad,c=H.afterFullData,o=H.scrollYStore;if(u)e=y.getVTRowIndex(e.row),n=r?c.slice(e,e+Math.ceil(a/o.rowHeight)):c.slice(e-Math.floor(a/o.rowHeight)+1,e+1);else for(var i=r?"next":"previous";t&&l<a;){var s=y.getRowNode(t);s&&(n.push(s.item),l+=t.offsetHeight,t=t[i+"ElementSibling"])}return n}(u,f,n<h?-r:r);10<r&&n.length!==m.length&&(m=n,e.ctrlKey?n.forEach(function(e){y.handleSelectRow({row:e},-1===g.indexOf(e))}):(y.setAllCheckboxRow(!1),y.setCheckboxRow(n,!0)),R("change",e))},I=function(){clearTimeout(b),b=null},(T=!(r=function r(a){I(),b=setTimeout(function(){var e,t,o,l,n;b&&(e=s.scrollLeft,t=s.scrollTop,o=s.clientHeight,l=s.scrollHeight,n=Math.ceil(50*C/w),T?t+o<l?(y.scrollTo(e,t+n),r(a),_(a)):I():t?(y.scrollTo(e,t-n),r(a),_(a)):I())},50)}),_dom.addClass)(t,"drag--range"),document.onmousemove=function(e){e.preventDefault(),e.stopPropagation();var t=e.clientY,o=(0,_dom.getAbsolutePos)(s).boundingTop;t<o?(T=!1,C=o-t,b||r(e)):t>o+s.clientHeight?(T=!0,C=t-o-s.clientHeight,b||r(e)):b&&I(),_(e)},document.onmouseup=function(e){I(),(0,_dom.removeClass)(t,"drag--range"),d.removeAttribute("style"),document.onmousemove=l,document.onmouseup=n,R("end",e)},R("start",e))}return{moveTabSelected:function(e,t,o){var l,n,r,a=f.editConfig,u=H.afterFullData,c=H.visibleColumn,i=g.value,s=Object.assign({},e),d=y.getVTRowIndex(s.row),e=y.getVTColumnIndex(s.column);o.preventDefault(),t?e<=0?0<d&&(l=u[n=d-1],r=c.length-1):r=e-1:e>=c.length-1?d<u.length-1&&(l=u[n=d+1],r=0):r=e+1;c=c[r];c&&(l?(s.rowIndex=n,s.row=l):s.rowIndex=d,s.columnIndex=r,s.column=c,s.cell=y.getCell(s.row,s.column),a?"click"!==i.trigger&&"dblclick"!==i.trigger||("row"===i.mode?y.handleActived(s,o):y.scrollToRow(s.row,s.column).then(function(){return y.handleSelected(s,o)})):y.scrollToRow(s.row,s.column).then(function(){return y.handleSelected(s,o)}))},moveCurrentRow:function(e,t,o){var l,n,r,a=f.treeConfig,u=k.currentRow,c=H.afterFullData,i=s.value;o.preventDefault(),u?a?(n=(i=_xeUtils.default.findTree(c,function(e){return e===u},i)).index,i=i.items,e&&0<n?l=i[n-1]:t&&n<i.length-1&&(l=i[n+1])):(n=y.getVTRowIndex(u),e&&0<n?l=c[n-1]:t&&n<c.length-1&&(l=c[n+1])):l=c[0],l&&(r={$table:y,row:l,rowIndex:y.getRowIndex(l),$rowIndex:y.getVMRowIndex(l)},y.scrollToRow(l).then(function(){return y.triggerCurrentRowEvent(o,r)}))},moveSelected:function(e,t,o,l,n,r){var a=H.afterFullData,u=H.visibleColumn,c=Object.assign({},e),i=y.getVTRowIndex(c.row),e=y.getVTColumnIndex(c.column);r.preventDefault(),o&&0<i?(c.rowIndex=i-1,c.row=a[c.rowIndex]):n&&i<a.length-1?(c.rowIndex=i+1,c.row=a[c.rowIndex]):t&&e?(c.columnIndex=e-1,c.column=u[c.columnIndex]):l&&e<u.length-1&&(c.columnIndex=e+1,c.column=u[c.columnIndex]),y.scrollToRow(c.row,c.column).then(function(){c.cell=y.getCell(c.row,c.column),y.handleSelected(c,r)})},triggerHeaderCellMousedownEvent:function(e,t){var o,l=f.mouseConfig,n=i.value;l&&n.area&&y.handleHeaderCellAreaEvent&&(o=e.currentTarget,l=(0,_dom.getEventTargetNode)(e,o,"vxe-cell--sort").flag,n=(0,_dom.getEventTargetNode)(e,o,"vxe-cell--filter").flag,y.handleHeaderCellAreaEvent(e,Object.assign({cell:o,triggerSort:l,triggerFilter:n},t))),y.focus(),y.closeMenu&&y.closeMenu()},triggerCellMousedownEvent:function(e,t){var o=e.currentTarget;t.cell=o,function(e,t){var o=f.editConfig,l=f.checkboxConfig,n=f.mouseConfig,r=c.value,a=i.value,u=g.value;if(n&&a.area&&y.handleCellAreaEvent)return y.handleCellAreaEvent(e,t);l&&r.range&&d(e,t),n&&a.selected&&(o&&"cell"!==u.mode||y.handleSelected(t,e))}(e,t),y.focus(),y.closeFilter(),y.closeMenu&&y.closeMenu()}}}},_default=tableKeyboardHook;exports.default=_default;