"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=require("../../v-x-e-table"),_util=require("../../table/src/util"),_dom=require("../../tools/dom");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,l=1,r=arguments.length;l<r;l++)for(var i in t=arguments[l])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},tableFilterMethodKeys=["setFilter","clearFilter","getCheckedFilters"],tableFilterHook={setupTable:function(f){var s=f.reactData,a=f.internalData,e=f.getRefMaps(),_=e.refTableBody,b=e.refTableFilter,c=f.getComputeMaps().computeFilterOpts,n={checkFilterOptions:function(){var e=s.filterStore;e.isAllSelected=e.options.every(function(e){return e._checked}),e.isIndeterminate=!e.isAllSelected&&e.options.some(function(e){return e._checked})},triggerFilterEvent:function(e,d,t){var h,p,v,l,r,i,n,o=s.initStore,m=s.filterStore;m.column===d&&m.visible?m.visible=!1:(h=e.target,p=e.pageX,v=(0,_dom.getDomNode)().visibleWidth,l=d.filters,r=d.filterMultiple,i=(i=d.filterRender)?_vXETable.VXETable.renderer.get(i.name):null,n=d.filterRecoverMethod||(i?i.filterRecoverMethod:null),a._currFilterParams=t,Object.assign(m,{multiple:r,options:l,column:d,style:null}),m.options.forEach(function(e){var t=e._checked,l=e.checked;(e._checked=l)||t===l||n&&n({option:e,column:d,$table:f})}),this.checkFilterOptions(),m.visible=!0,o.filter=!0,(0,_vue.nextTick)(function(){var e=_.value.$el,t=b.value,l=t?t.$el:null,r=0,i=0,n=null,o=null;l&&(r=l.offsetWidth,i=l.offsetHeight,n=l.querySelector(".vxe-table--filter-header"),o=l.querySelector(".vxe-table--filter-footer"));var a,u,f,s=r/2,c=e.clientWidth-r-10,t={top:h.offsetTop+h.offsetParent.offsetTop+h.offsetHeight+8+"px"},l=null;i>=e.clientHeight&&(l=Math.max(60,e.clientHeight-(o?o.offsetHeight:0)-(n?n.offsetHeight:0))),"left"===d.fixed?a=h.offsetLeft+h.offsetParent.offsetLeft-s:"right"===d.fixed?u=h.offsetParent.offsetWidth-h.offsetLeft+(h.offsetParent.offsetParent.offsetWidth-h.offsetParent.offsetLeft)-d.renderWidth-s:a=h.offsetLeft+h.offsetParent.offsetLeft-s-e.scrollLeft,a?(0<(f=p+r-s+10-v)&&(a-=f),t.left=Math.min(c,Math.max(10,a))+"px"):u&&(0<(f=p+r-s+10-v)&&(u+=f),t.right=Math.max(10,u)+"px"),m.style=t,m.maxHeight=l})),f.dispatchEvent("filter-visible",{column:d,property:d.property,filterList:f.getCheckedFilters(),visible:m.visible},e)},handleClearFilter:function(e){var t,l,r;e&&(t=e.filters,l=e.filterRender,t&&(l=l?_vXETable.VXETable.renderer.get(l.name):null,r=e.filterResetMethod||(l?l.filterResetMethod:null),t.forEach(function(e){e._checked=!1,e.checked=!1,r||(e.data=_xeUtils.default.clone(e.resetValue,!0))}),r&&r({options:t,column:e,$table:f})))},confirmFilterEvent:function(e){var t=s.filterStore,l=s.scrollXLoad,r=s.scrollYLoad,i=c.value,n=t.column,o=n.property,a=[],u=[];n.filters.forEach(function(e){e.checked&&(a.push(e.value),u.push(e.data))});t=f.getCheckedFilters();i.remote||(f.handleTableData(!0),f.checkSelectionStatus()),f.dispatchEvent("filter-change",{column:n,property:o,values:a,datas:u,filters:t,filterList:t},e),f.closeFilter(),f.updateFooter().then(function(){var e=s.scrollXLoad,t=s.scrollYLoad;if(l||e||r||t)return(l||e)&&f.updateScrollXSpace(),(r||t)&&f.updateScrollYSpace(),f.refreshScroll()}).then(function(){return f.updateCellAreas(),f.recalculate(!0)}).then(function(){setTimeout(function(){return f.recalculate()},50)})}};return __assign(__assign({},{openFilter:function(e){var t=(0,_util.handleFieldOrColumn)(f,e);if(t&&t.filters){var l=a.elemStore,r=t.fixed;return f.scrollToColumn(t).then(function(){var e=l[(r||"main")+"-header-wrapper"]||l["main-header-wrapper"];e&&(e=e.querySelector(".vxe-header--column."+t.id+" .vxe-filter--btn"),(0,_dom.triggerEvent)(e,"click"))})}return(0,_vue.nextTick)()},setFilter:function(e,t){e=(0,_util.handleFieldOrColumn)(f,e);return e&&e.filters&&t&&(e.filters=(0,_util.toFilters)(t)),(0,_vue.nextTick)()},clearFilter:function(e){var t,l=s.filterStore,r=a.tableFullColumn,i=c.value;return e?(t=(0,_util.handleFieldOrColumn)(f,e))&&n.handleClearFilter(t):r.forEach(n.handleClearFilter),e&&t===l.column||Object.assign(l,{isAllSelected:!1,isIndeterminate:!1,style:null,options:[],column:null,multiple:!1,visible:!1}),i.remote?(0,_vue.nextTick)():f.updateData()},getCheckedFilters:function(){var e=a.tableFullColumn,n=[];return e.filter(function(e){var t=e.property,l=e.filters,r=[],i=[];l&&l.length&&(l.forEach(function(e){e.checked&&(r.push(e.value),i.push(e.data))}),r.length&&n.push({column:e,property:t,values:r,datas:i}))}),n}}),n)},setupGrid:function(e){return e.extendTableMethods(tableFilterMethodKeys)}},_default=tableFilterHook;exports.default=_default;