"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=require("../../v-x-e-table"),_utils=require("../../tools/utils"),_log=require("../../tools/log"),_dom=require("../../tools/dom"),_util=require("./util"),_render=require("./render"),_size=require("../../hooks/size");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var l in t=arguments[i])Object.prototype.hasOwnProperty.call(t,l)&&(e[l]=t[l]);return e}).apply(this,arguments)},Rule=function(){function e(e){Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return Object.defineProperty(e.prototype,"content",{get:function(){return(0,_utils.getFuncText)(this.$options.content||this.$options.message)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"message",{get:function(){return this.content},enumerable:!1,configurable:!0}),e}(),validErrorRuleValue=function(e,t){var i=e.type,n=e.min,l=e.max,r=e.pattern,e="number"===i,i=e?_xeUtils.default.toNumber(t):_xeUtils.default.getSize(t);return!(!e||!isNaN(t))||(!_xeUtils.default.eqNull(n)&&i<_xeUtils.default.toNumber(n)||(!_xeUtils.default.eqNull(l)&&i>_xeUtils.default.toNumber(l)||!(!r||(_xeUtils.default.isRegExp(r)?r:new RegExp(r)).test(t))))};function getResetValue(e,t){return t=_xeUtils.default.isArray(e)?[]:t}var _default2=(0,_vue.defineComponent)({name:"VxeForm",props:{collapseStatus:{type:Boolean,default:!0},loading:Boolean,data:Object,size:{type:String,default:function(){return _conf.default.form.size||_conf.default.size}},span:{type:[String,Number],default:function(){return _conf.default.form.span}},align:{type:String,default:function(){return _conf.default.form.align}},titleAlign:{type:String,default:function(){return _conf.default.form.titleAlign}},titleWidth:{type:[String,Number],default:function(){return _conf.default.form.titleWidth}},titleColon:{type:Boolean,default:function(){return _conf.default.form.titleColon}},titleAsterisk:{type:Boolean,default:function(){return _conf.default.form.titleAsterisk}},titleOverflow:{type:[Boolean,String],default:null},className:[String,Function],items:Array,rules:Object,preventSubmit:{type:Boolean,default:function(){return _conf.default.form.preventSubmit}},validConfig:Object,tooltipConfig:Object,customLayout:{type:Boolean,default:function(){return _conf.default.form.customLayout}}},emits:["update:collapseStatus","collapse","toggle-collapse","submit","submit-invalid","reset"],setup:function(q,e){function t(e){return e.length&&("development"===process.env.NODE_ENV&&e.forEach(function(e){e.slots&&_xeUtils.default.each(e.slots,function(e){_xeUtils.default.isFunction(e)||v[e]||(0,_log.errLog)("vxe.error.notSlot",[e])})}),p.staticItems=_xeUtils.default.mapTree(e,function(e){return(0,_util.createItem)(V,e)},{children:"children"})),(0,_vue.nextTick)()}function o(t){var e=_xeUtils.default.findTree(p.formItems,function(e){return e.field===t},{children:"children"});return e?e.item:null}function i(){return p.collapseAll}function n(){var e=!i();return p.collapseAll=e,l("update:collapseStatus",e),(0,_vue.nextTick)()}function c(e){e.preventDefault(),R(),h.dispatchEvent("reset",{data:q.data},e)}function f(t){t.preventDefault(),q.preventSubmit||(U(),w(T()).then(function(){h.dispatchEvent("submit",{data:q.data},t)}).catch(function(e){h.dispatchEvent("submit-invalid",{data:q.data,errMap:e},t)}))}function u(){var e=a.tooltipStore,t=g.value;return e.visible&&(Object.assign(e,{item:null,visible:!1}),t&&t.close()),(0,_vue.nextTick)()}function C(e){var R=q.data,O=q.rules,S=q.titleOverflow,w=p.collapseAll,N=x.value;return e.map(function(e){var t=e.slots,i=e.title,n=e.visible,l=e.folding,r=e.visibleMethod,o=e.field,u=e.collapseNode,a=e.itemRender,s=e.showError,c=e.errRule,f=e.className,d=e.titleOverflow,v=e.children,m=(0,_utils.isEnableConf)(a)?_vXETable.VXETable.renderer.get(a.name):null,p=t?t.default:null,_=t?t.title:null,g=e.span||q.span,h=e.align||q.align,x=e.titleAlign||q.titleAlign,b=e.titleWidth||q.titleWidth,y=_xeUtils.default.isUndefined(d)||_xeUtils.default.isNull(d)?S:d,E="title"===y,t=!0===y||"tooltip"===y,d=E||t||"ellipsis"===y,y=r,T={data:R,field:o,property:o,item:e,$form:V};if(!1===n)return(0,_vue.createCommentVNode)();r=!1;if(!O||(n=O[o])&&(r=n.some(function(e){return e.required})),v&&0<v.length){var U=C(e.children);return U.length?(0,_vue.h)("div",{class:["vxe-form--gather vxe-row",e.id,g?"vxe-col--"+g+" is--span":"",f?_xeUtils.default.isFunction(f)?f(T):f:""]},U):(0,_vue.createCommentVNode)()}!y&&m&&m.itemVisibleMethod&&(y=m.itemVisibleMethod);U=[];p?U=I(p,T):m&&m.renderItemContent?U=m.renderItemContent(a,T):o&&(U=[""+_xeUtils.default.get(R,o)]),u&&U.push((0,_vue.h)("div",{class:"vxe-form--item-trigger-node",onClick:j},[(0,_vue.h)("span",{class:"vxe-form--item-trigger-text"},w?_conf.default.i18n("vxe.form.unfolding"):_conf.default.i18n("vxe.form.folding")),(0,_vue.h)("i",{class:["vxe-form--item-trigger-icon",w?_conf.default.icon.FORM_FOLDING:_conf.default.icon.FORM_UNFOLDING]})])),c&&N.showMessage&&U.push((0,_vue.h)("div",{class:"vxe-form--item-valid",style:c.maxWidth?{width:c.maxWidth+"px"}:null},c.content));t=t?{onMouseenter:function(e){F(e,T)},onMouseleave:A}:{};return(0,_vue.h)("div",{class:["vxe-form--item",e.id,g?"vxe-col--"+g+" is--span":"",f?_xeUtils.default.isFunction(f)?f(T):f:"",{"is--title":i,"is--required":r,"is--hidden":l&&w,"is--active":!y||y(T),"is--error":s}],key:e.id},[(0,_vue.h)("div",{class:"vxe-form--item-inner"},[i||_?(0,_vue.h)("div",__assign({class:["vxe-form--item-title",x?"align--"+x:null,{"is--ellipsis":d}],style:b?{width:isNaN(b)?b:b+"px"}:null,title:E?(0,_utils.getFuncText)(i):null},t),(0,_render.renderTitle)(V,e)):null,(0,_vue.h)("div",{class:["vxe-form--item-content",h?"align--"+h:null]},U)])])})}var s,d=_vXETable.VXETable.tooltip,v=e.slots,l=e.emit,r=_xeUtils.default.uniqueId(),m=(0,_size.useSize)(q),p=(0,_vue.reactive)({collapseAll:q.collapseStatus,staticItems:[],formItems:[]}),a=(0,_vue.reactive)({tooltipTimeout:null,tooltipStore:{item:null,visible:!1}}),_=(0,_vue.ref)(),g=(0,_vue.ref)(),h={},x=(0,_vue.computed)(function(){return Object.assign({},_conf.default.form.validConfig,q.validConfig)}),b=(0,_vue.computed)(function(){return Object.assign({},_conf.default.tooltip,_conf.default.form.tooltipConfig,q.tooltipConfig)}),y={refElem:_},E={computeSize:m,computeValidOpts:x,computeTooltipOpts:b},V={xID:r,props:q,context:e,reactData:p,getRefMaps:function(){return y},getComputeMaps:function(){return E}},I=function(e,t){return e&&(_xeUtils.default.isString(e)&&(e=v[e]||null),_xeUtils.default.isFunction(e))?e(t):[]},T=function(){var t=[];return _xeUtils.default.eachTree(p.formItems,function(e){t.push(e)},{children:"children"}),t},j=function(e){n();var t=i();h.dispatchEvent("toggle-collapse",{status:t,collapse:t,data:q.data},e),h.dispatchEvent("collapse",{status:t,collapse:t,data:q.data},e)},U=function(e){return e?(e=(0,_util.handleFieldOrItem)(V,e))&&(e.showError=!1):T().forEach(function(e){e.showError=!1}),(0,_vue.nextTick)()},R=function(){var l=q.data,e=T();return l&&e.forEach(function(e){var t=e.field,i=e.resetValue,n=e.itemRender;(0,_utils.isEnableConf)(n)&&((n=_vXETable.VXETable.renderer.get(n.name))&&n.itemResetMethod?n.itemResetMethod({data:l,field:t,property:t,item:e,$form:V}):t&&_xeUtils.default.set(l,t,null===i?getResetValue(_xeUtils.default.get(l,t),void 0):i))}),U()},O=function(e){var r=_.value;e.some(function(e,t){var i=o(e);if(i&&(0,_utils.isEnableConf)(i.itemRender)){var n=i.itemRender,l=_vXETable.VXETable.renderer.get(n.name),e=null;if(t||(0,_dom.scrollToView)(r.querySelector("."+i.id)),e=!(e=n.autofocus?r.querySelector("."+i.id+" "+n.autofocus):e)&&l&&l.autofocus?r.querySelector("."+i.id+" "+l.autofocus):e)return e.focus(),!0}})},S=function(r,o,e){var u,a,s=q.data,t=q.rules,c=[],f=[];return o&&t&&((u=_xeUtils.default.get(t,o))&&(a=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(s,o):e,u.forEach(function(t){var e,i=t.type,n=t.trigger,l=t.required;"all"!==r&&n&&r!==n||(_xeUtils.default.isFunction(t.validator)?(e=t.validator({itemValue:a,rule:t,rules:u,data:s,field:o,property:o,$form:V}))&&(_xeUtils.default.isError(e)?c.push(new Rule({type:"custom",trigger:n,content:e.message,rule:new Rule(t)})):e.catch&&f.push(e.catch(function(e){c.push(new Rule({type:"custom",trigger:n,content:e?e.message:t.content||t.message,rule:new Rule(t)}))}))):(i="array"===i?!_xeUtils.default.isArray(a)||!a.length:(0,_utils.eqEmptyValue)(a),(l?i||validErrorRuleValue(t,a):!i&&validErrorRuleValue(t,a))&&c.push(new Rule(t))))}))),Promise.all(f).then(function(){if(c.length){var e={rules:c,rule:c[0]};return Promise.reject(e)}})},w=function(t,e,i){var l=q.data,n=q.rules,r=x.value,o={},u=[],a=[];return clearTimeout(s),l&&n?(t.forEach(function(i){var n=i.field;n&&a.push(S(e||"all",n).then(function(){i.errRule=null}).catch(function(e){var t=e.rule,e={rule:t,rules:e.rules,data:l,field:n,property:n,$form:V};return o[n]||(o[n]=[]),o[n].push(e),u.push(n),i.errRule=t,Promise.reject(e)}))}),Promise.all(a).then(function(){i&&i()}).catch(function(){return new Promise(function(e){s=window.setTimeout(function(){t.forEach(function(e){e.errRule&&(e.showError=!0)})},20),!1!==r.autoPos&&(0,_vue.nextTick)(function(){O(u)}),i?(i(o),e()):e(o)})})):(i&&i(),Promise.resolve())},F=function(e,t){var i=t.item,n=a.tooltipStore,l=g.value,r=e.currentTarget.children[0],t=(r.textContent||"").trim(),e=r.scrollWidth>r.clientWidth;clearTimeout(a.tooltipTimeout),n.item!==i&&u(),t&&e&&(Object.assign(n,{item:i,visible:!0}),l&&l.open(r,t))},A=function(){var e=b.value,t=g.value;t&&t.setActived(!1),e.enterable?a.tooltipTimeout=setTimeout(function(){(t=g.value)&&!t.isActived()&&u()},e.leaveDelay):u()},h={dispatchEvent:function(e,t,i){l(e,Object.assign({$form:V,$event:i},t))},reset:R,validate:function(e){return U(),w(T(),"",e)},validateField:function(e,t){e=(0,_util.handleFieldOrItem)(V,e);return w(e?[e]:[],"",t)},clearValidate:U,updateStatus:function(e,t){var i=e.property;i&&S("change",i,t).then(function(){U(i)}).catch(function(e){var t=e.rule,e=o(i);e&&(e.showError=!0,e.errRule=t)})},toggleCollapse:n,getItems:T,getItemByField:o,closeTooltip:u};Object.assign(V,h,{callSlot:I,toggleCollapseEvent:j,triggerTitleTipEvent:F,handleTitleTipLeaveEvent:A}),(0,_vue.watch)(function(){return p.staticItems},function(e){p.formItems=e}),(0,_vue.watch)(function(){return q.items},function(e){t(e||[])}),(0,_vue.watch)(function(){return q.collapseStatus},function(e){p.collapseAll=!!e}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){"development"===process.env.NODE_ENV&&q.customLayout&&q.items&&(0,_log.errLog)("vxe.error.errConflicts",["custom-layout","items"]),t(q.items||[])})});return V.renderVN=function(){var e=q.loading,t=q.className,i=q.data,n=q.titleColon,l=q.titleAsterisk,r=q.customLayout,o=p.formItems,u=m.value,a=b.value,s=v.default;return(0,_vue.h)("form",{ref:_,class:["vxe-form",t?_xeUtils.default.isFunction(t)?t({items:o,data:i,$form:V}):t:"",((t={})["size--"+u]=u,t["is--colon"]=n,t["is--asterisk"]=l,t["is--loading"]=e,t)],onSubmit:f,onReset:c},[(0,_vue.h)("div",{class:"vxe-form--wrapper vxe-row"},r?s?s({}):[]:C(o)),(0,_vue.h)("div",{class:"vxe-form-slots",ref:"hideItem"},!r&&s?s({}):[]),(0,_vue.h)("div",{class:["vxe-loading",{"is--visible":e}]},[(0,_vue.h)("div",{class:"vxe-loading--spinner"})]),d?(0,_vue.h)((0,_vue.resolveComponent)("vxe-tooltip"),__assign({ref:g},a)):(0,_vue.createCommentVNode)()])},(0,_vue.provide)("$xeform",V),V},render:function(){return this.renderVN()}});exports.default=_default2;