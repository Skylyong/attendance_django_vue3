"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_vXETable=require("../../v-x-e-table"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,l=arguments.length;n<l;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},tableMenuMethodKeys=["closeMenu"],tableMenuHook={setupTable:function(_){function m(t,e,n){var v,f=E.ctxMenuStore,l=i.value,o=O.value,e=o[e],g=o.visibleMethod;e&&(v=e.options,e.disabled?t.preventDefault():l&&v&&v.length&&(n.options=v,_.preventEvent(t,"event.showMenu",n,function(){var o,i,u,r,s,a,l,e,d,c;!g||g(n)?(t.preventDefault(),_.updateZindex(),e=(0,_dom.getDomNode)(),o=e.scrollTop,i=e.scrollLeft,u=e.visibleHeight,r=e.visibleWidth,s=t.clientY+o,a=t.clientX+i,l=function(){C._currMenuParams=n,Object.assign(f,{visible:!0,list:v,selected:null,selectChild:null,showChild:!1,style:{zIndex:C.tZindex,top:s+"px",left:a+"px"}}),(0,_vue.nextTick)(function(){var e=w.value.getRefMaps().refElem.value,t=e.clientHeight,n=e.clientWidth,l=(0,_dom.getAbsolutePos)(e),e=l.boundingTop,l=l.boundingLeft+n-r;-10<e+t-u&&(f.style.top=Math.max(o+2,s-t-2)+"px"),-10<l&&(f.style.left=Math.max(i+2,a-n-2)+"px")})},e=n.keyboard,d=n.row,c=n.column,e&&d&&c?_.scrollToRow(d,c).then(function(){var e,t,n=_.getCell(d,c);n&&(e=(t=(0,_dom.getAbsolutePos)(n)).boundingTop,t=t.boundingLeft,s=e+o+Math.floor(n.offsetHeight/2),a=t+i+Math.floor(n.offsetWidth/2)),l()}):l()):R.closeMenu()}))),_.closeFilter()}var x=_.xID,M=_.props,E=_.reactData,C=_.internalData,e=_.getRefMaps(),y=e.refElem,T=e.refTableFilter,w=e.refTableMenu,e=_.getComputeMaps(),N=e.computeMouseOpts,i=e.computeIsMenu,O=e.computeMenuOpts,R={},d={},d={moveCtxMenu:function(e,t,n,l,o,i){var u,r=_xeUtils.default.findIndexOf(i,function(e){return t[n]===e});if(l)o&&(0,_utils.hasChildrenList)(t.selected)?t.showChild=!0:(t.showChild=!1,t.selectChild=null);else if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_UP)){for(var s=r-1;0<=s;s--)if(!1!==i[s].visible){u=i[s];break}t[n]=u||i[i.length-1]}else if((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_DOWN)){for(var a=r+1;a<i.length;a++)if(!1!==i[a].visible){u=i[a];break}t[n]=u||i[0]}else t[n]&&((0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER)||(0,_event.hasEventKey)(e,_event.EVENT_KEYS.SPACEBAR))&&d.ctxMenuLinkEvent(e,t[n])},handleGlobalContextmenuEvent:function(e){var t=M.mouseConfig,n=M.menuConfig,l=E.editStore,o=E.ctxMenuStore,i=C.visibleColumn,u=T.value,r=w.value,s=N.value,a=O.value,d=y.value,l=l.selected,c=["header","body","footer"];if((0,_utils.isEnableConf)(n)){if(o.visible&&r&&(0,_dom.getEventTargetNode)(e,r.getRefMaps().refElem.value).flag)return void e.preventDefault();if(C._keyCtx){var o="body",v={type:o,$table:_,keyboard:!0,columns:i.slice(0),$event:e};if(t&&s.area){r=_.getActiveCellArea();if(r&&r.row&&r.column)return v.row=r.row,v.column=r.column,void m(e,o,v)}else if(t&&s.selected&&l.row&&l.column)return v.row=l.row,v.column=l.column,void m(e,o,v)}for(var f=0;f<c.length;f++){var g=c[f],h=(0,_dom.getEventTargetNode)(e,d,"vxe-"+g+"--column",function(e){return e.parentNode.parentNode.parentNode.getAttribute("xid")===x}),v={type:g,$table:_,columns:i.slice(0),$event:e};if(h.flag){var b=h.targetElem,p=_.getColumnNode(b),h=p?p.item:null,p=g+"-";h&&Object.assign(v,{column:h,columnIndex:_.getColumnIndex(h),cell:b}),"body"===g&&(p="",(b=(b=_.getRowNode(b.parentNode))?b.item:null)&&(v.row=b,v.rowIndex=_.getRowIndex(b)));p=p+"cell-menu";return m(e,g,v),void _.dispatchEvent(p,v,e)}if((0,_dom.getEventTargetNode)(e,d,"vxe-table--"+g+"-wrapper",function(e){return e.getAttribute("xid")===x}).flag)return void("cell"===a.trigger?e.preventDefault():m(e,g,v))}}u&&!(0,_dom.getEventTargetNode)(e,u.$el).flag&&_.closeFilter(),R.closeMenu()},ctxMenuMouseoverEvent:function(e,t,n){var r=e.currentTarget,l=E.ctxMenuStore;e.preventDefault(),e.stopPropagation(),l.selected=t,(l.selectChild=n)||(l.showChild=(0,_utils.hasChildrenList)(t),l.showChild&&(0,_vue.nextTick)(function(){var e,t,n,l,o,i,u=r.nextElementSibling;u&&(l=(n=(0,_dom.getAbsolutePos)(r)).boundingTop,o=n.boundingLeft,e=n.visibleHeight,i=n.visibleWidth,t=l+r.offsetHeight,l=n="",o+r.offsetWidth+u.offsetWidth>i-10&&(n="auto",l=r.offsetWidth+"px"),i=o="",t+u.offsetHeight>e-10&&(o="auto",i="0"),u.style.left=n,u.style.right=l,u.style.top=o,u.style.bottom=i)}))},ctxMenuMouseoutEvent:function(e,t){var n=E.ctxMenuStore;t.children||(n.selected=null),n.selectChild=null},ctxMenuLinkEvent:function(e,t){var n;t.disabled||!t.code&&t.children&&t.children.length||(n=_vXETable.VXETable.menus.get(t.code),t=Object.assign({},C._currMenuParams,{menu:t,$table:_,$grid:_.xegrid,$event:e}),n&&n(t,e),_.dispatchEvent("menu-click",t,e),R.closeMenu())}};return __assign(__assign({},R={closeMenu:function(){return Object.assign(E.ctxMenuStore,{visible:!1,selected:null,selectChild:null,showChild:!1}),(0,_vue.nextTick)()}}),d)},setupGrid:function(e){return e.extendTableMethods(tableMenuMethodKeys)}},_default=tableMenuHook;exports.default=_default;