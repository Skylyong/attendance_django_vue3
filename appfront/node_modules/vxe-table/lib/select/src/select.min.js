"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function isOptionVisible(e){return!1!==e.visible}function getOptUniqueId(){return _xeUtils.default.uniqueId("opt_")}var _default2=(0,_vue.defineComponent)({name:"VxeSelect",props:{modelValue:null,clearable:Boolean,placeholder:String,loading:Boolean,disabled:Boolean,multiple:Boolean,multiCharOverflow:{type:[Number,String],default:function(){return _conf.default.select.multiCharOverflow}},prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,optionConfig:Object,className:[String,Function],size:{type:String,default:function(){return _conf.default.select.size||_conf.default.size}},emptyText:String,optionId:{type:String,default:function(){return _conf.default.select.optionId}},optionKey:Boolean,transfer:{type:Boolean,default:function(){return _conf.default.select.transfer}}},emits:["update:modelValue","change","clear"],setup:function(m,e){function x(e,t){return e&&(_xeUtils.default.isString(e)&&(e=b[e]||null),_xeUtils.default.isFunction(e))?e(t):[]}function v(t){var e=y.fullOptionList,n=y.fullGroupList,i=D.value,o=C.value;if(i)for(var l=0;l<n.length;l++){var u=n[l];if(u.options)for(var r=0;r<u.options.length;r++){var a=u.options[r];if(t===a[o])return a}}return e.find(function(e){return t===e[o]})}function i(e){var t=k.value,n=v(e);return _xeUtils.default.toValueString(n?n[t]:e)}function l(){var e=y.fullOptionList,t=y.fullGroupList;return D.value?y.visibleGroupList=t.filter(isOptionVisible):y.visibleOptionList=e.filter(isOptionVisible),(0,_vue.nextTick)()}function n(){function t(e){B(e)||(e[o]=getOptUniqueId())}var e=y.fullOptionList,n=y.fullGroupList,i=U.value,o=j();n.length?n.forEach(function(e){t(e),e[i]&&e[i].forEach(t)}):e.length&&e.forEach(t),l()}function h(e){var t=C.value;e&&(y.currentValue=e[t])}function c(i,o){return(0,_vue.nextTick)().then(function(){var e,t,n;i&&(e=P.value,t=S.value.querySelector("[optid='"+B(i)+"']"),e&&t&&(n=e.offsetHeight,o?t.offsetTop+t.offsetHeight-e.scrollTop>n&&(e.scrollTop=t.offsetTop+t.offsetHeight-n):(t.offsetTop+5<e.scrollTop||t.offsetTop+5>e.scrollTop+e.clientHeight)&&(e.scrollTop=t.offsetTop-5)))})}function o(){return(0,_vue.nextTick)().then(function(){var e=m.transfer,t=m.placement,n=y.panelIndex,i=L.value,o=S.value;if(o&&i){var l=i.offsetHeight,u=i.offsetWidth,r=o.offsetHeight,a=o.offsetWidth,s={zIndex:n},f=(0,_dom.getAbsolutePos)(i),v=f.boundingTop,o=f.boundingLeft,n=f.visibleHeight,i=f.visibleWidth,f="bottom";return e?(e=v+l,"top"===t?(f="top",e=v-r):t||(n<e+r+5&&(f="top",e=v-r),e<5&&(f="bottom",e=v+l)),i<(o=o)+a+5&&(o-=o+a+5-i),o<5&&(o=5),Object.assign(s,{left:o+"px",top:e+"px",minWidth:u+"px"})):"top"===t?(f="top",s.bottom=l+"px"):t||n<v+l+r&&5<v-l-r&&(f="top",s.bottom=l+"px"),y.panelStyle=s,y.panelPlacement=f,(0,_vue.nextTick)()}})}function f(e,t){H(t,null),$()}function g(e,t){var n,i=m.modelValue;m.multiple?(n=void 0,n=i?-1===i.indexOf(t)?i.concat([t]):i.filter(function(e){return e!==t}):[t],Y(e,n)):(Y(e,t),$())}function t(e){var t=m.disabled,n=y.visiblePanel;t||n&&(n=S.value,((0,_dom.getEventTargetNode)(e,n).flag?o:$)())}function u(e){var t,n=m.disabled,i=y.visiblePanel;n||(t=L.value,n=S.value,y.isActivated=(0,_dom.getEventTargetNode)(e,t).flag||(0,_dom.getEventTargetNode)(e,n).flag,i&&!y.isActivated&&$())}function r(e){var t,n,i,o,l,u,r=m.clearable,a=m.disabled,s=y.visiblePanel,f=y.currentValue;a||(l=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.TAB),t=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER),u=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ESCAPE),n=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_UP),i=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_DOWN),o=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.DELETE),a=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.SPACEBAR),l&&(y.isActivated=!1),s?u||l?$():t?(e.preventDefault(),e.stopPropagation(),g(e,f)):n||i?(e.preventDefault(),l=(u=function(e,t){var n,i,o,l,u=y.visibleOptionList,r=y.visibleGroupList,a=D.value,s=C.value,f=U.value;if(a)for(var v=0;v<r.length;v++){var c=r[v],p=c[f],d=c.disabled;if(p)for(var _=0;_<p.length;_++){var b=isOptionVisible(x=p[_]),m=d||x.disabled;if(n||m||(n=x),l&&b&&!m&&(o=x,!t))return{offsetOption:o};if(e===x[s]){if(l=x,t)return{offsetOption:i}}else b&&!m&&(i=x)}}else for(_=0;_<u.length;_++){var x,m=(x=u[_]).disabled;if(n||m||(n=x),l&&!m&&(o=x,!t))return{offsetOption:o};if(e===x[s]){if(l=x,t)return{offsetOption:i}}else m||(i=x)}return{firstOption:n}}(f,n)).firstOption,(u=u.offsetOption)||v(f)||(u=l),h(u),c(u,i)):a&&e.preventDefault():(n||i||t||a)&&y.isActivated&&(e.preventDefault(),F()),y.isActivated&&o&&r&&H(e,null))}function a(){$()}function p(){m.disabled||(y.isActivated=!0)}function d(){y.isActivated=!1}function _(e){e.$event.preventDefault(),(y.visiblePanel?$:F)()}var s,b=e.slots,E=e.emit,O=_xeUtils.default.uniqueId(),T=(0,_size.useSize)(m),y=(0,_vue.reactive)({inited:!1,staticOptions:[],fullGroupList:[],fullOptionList:[],visibleGroupList:[],visibleOptionList:[],panelIndex:0,panelStyle:{},panelPlacement:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1}),L=(0,_vue.ref)(),V=(0,_vue.ref)(),P=(0,_vue.ref)(),S=(0,_vue.ref)(),G={refElem:L},A={xID:O,props:m,context:e,reactData:y,getRefMaps:function(){return G}},N={},I=(0,_vue.computed)(function(){return m.optionProps||{}}),K=(0,_vue.computed)(function(){return m.optionGroupProps||{}}),k=(0,_vue.computed)(function(){return I.value.label||"label"}),C=(0,_vue.computed)(function(){return I.value.value||"value"}),w=(0,_vue.computed)(function(){return K.value.label||"label"}),U=(0,_vue.computed)(function(){return K.value.options||"options"}),q=(0,_vue.computed)(function(){return Object.assign({},_conf.default.select.optionConfig,m.optionConfig)}),D=(0,_vue.computed)(function(){return y.fullGroupList.some(function(e){return e.options&&e.options.length})}),R=(0,_vue.computed)(function(){return _xeUtils.default.toNumber(m.multiCharOverflow)}),z=(0,_vue.computed)(function(){var e=m.modelValue,t=m.multiple,n=R.value;return e&&t?(_xeUtils.default.isArray(e)?e:[e]).map(function(e){e=i(e);return 0<n&&e.length>n?e.substring(0,n)+"...":e}).join(", "):i(e)}),j=function(){return q.value.keyField||m.optionId||"_X_OPTION_KEY"},B=function(e){e=e[j()];return e?encodeURIComponent(e):""},F=function(){var e=m.loading,t=m.disabled;e||t||(clearTimeout(s),y.inited||(y.inited=!0),y.isActivated=!0,y.animatVisible=!0,setTimeout(function(){var e=m.modelValue,t=m.multiple,e=v(t&&e?e[0]:e);y.visiblePanel=!0,e&&(h(e),c(e))},10),y.panelIndex<(0,_utils.getLastZIndex)()&&(y.panelIndex=(0,_utils.nextZIndex)()),o())},$=function(){y.visiblePanel=!1,s=window.setTimeout(function(){y.animatVisible=!1},350)},Y=function(e,t){t!==m.modelValue&&(E("update:modelValue",t),N.dispatchEvent("change",{value:t},e))},H=function(e,t){Y(e,t),N.dispatchEvent("clear",{value:t},e)},W=function(e,a){var s=m.optionKey,f=m.modelValue,v=m.multiple,c=y.currentValue,t=q.value,p=k.value,d=C.value,_=D.value,b=t.useKey;return e.map(function(e,t){var n=e.slots,i=e.className,o=!_||isOptionVisible(e),l=a&&a.disabled||e.disabled,u=e[d],r=B(e),n=n?n.default:null;return o?(0,_vue.h)("div",{key:b||s?r:t,class:["vxe-select-option",i?_xeUtils.default.isFunction(i)?i({option:e,$select:A}):i:"",{"is--disabled":l,"is--selected":v?f&&-1<f.indexOf(u):f===u,"is--hover":c===u}],optid:r,onMousedown:function(e){0===e.button&&e.stopPropagation()},onClick:function(e){l||g(e,u)},onMouseenter:function(){l||h(e)}},n?x(n,{option:e,$select:A}):(0,_utils.formatText)((0,_utils.getFuncText)(e[p]))):null})},M=function(){var u=m.optionKey,e=y.visibleGroupList,t=q.value,r=w.value,a=U.value,s=t.useKey;return e.map(function(e,t){var n=e.slots,i=e.className,o=B(e),l=e.disabled,n=n?n.default:null;return(0,_vue.h)("div",{key:s||u?o:t,class:["vxe-optgroup",i?_xeUtils.default.isFunction(i)?i({option:e,$select:A}):i:"",{"is--disabled":l}],optid:o},[(0,_vue.h)("div",{class:"vxe-optgroup--title"},n?x(n,{option:e,$select:A}):(0,_utils.getFuncText)(e[r])),(0,_vue.h)("div",{class:"vxe-optgroup--wrapper"},W(e[a]||[],e))])})},N={dispatchEvent:function(e,t,n){E(e,Object.assign({$select:A,$event:n},t))},isPanelVisible:function(){return y.visiblePanel},togglePanel:function(){return(y.visiblePanel?$:F)(),(0,_vue.nextTick)()},hidePanel:function(){return y.visiblePanel&&$(),(0,_vue.nextTick)()},showPanel:function(){return y.visiblePanel||F(),(0,_vue.nextTick)()},refreshOption:l,focus:function(){var e=V.value;return y.isActivated=!0,e.blur(),(0,_vue.nextTick)()},blur:function(){return V.value.blur(),(y.isActivated=!1,_vue.nextTick)()}};Object.assign(A,N),(0,_vue.watch)(function(){return y.staticOptions},function(e){e.some(function(e){return e.options&&e.options.length})?(y.fullOptionList=[],y.fullGroupList=e):(y.fullGroupList=[],y.fullOptionList=e||[]),n()}),(0,_vue.watch)(function(){return m.options},function(e){y.fullGroupList=[],y.fullOptionList=e||[],n()}),(0,_vue.watch)(function(){return m.optionGroups},function(e){y.fullOptionList=[],y.fullGroupList=e||[],n()}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){var e=m.options,t=m.optionGroups;t?y.fullGroupList=t:e&&(y.fullOptionList=e),n()}),_event.GlobalEvent.on(A,"mousewheel",t),_event.GlobalEvent.on(A,"mousedown",u),_event.GlobalEvent.on(A,"keydown",r),_event.GlobalEvent.on(A,"blur",a)}),(0,_vue.onUnmounted)(function(){_event.GlobalEvent.off(A,"mousewheel"),_event.GlobalEvent.off(A,"mousedown"),_event.GlobalEvent.off(A,"keydown"),_event.GlobalEvent.off(A,"blur")});return A.renderVN=function(){var e=m.className,t=m.transfer,n=m.disabled,i=m.loading,o=y.inited,l=y.isActivated,u=y.visiblePanel,r=T.value,a=z.value,s=b.prefix;return(0,_vue.h)("div",{ref:L,class:["vxe-select",e?_xeUtils.default.isFunction(e)?e({$select:A}):e:"",((e={})["size--"+r]=r,e["is--visivle"]=u,e["is--disabled"]=n,e["is--loading"]=i,e["is--active"]=l,e)]},[(0,_vue.h)("div",{class:"vxe-select-slots",ref:"hideOption"},b.default?b.default({}):[]),(0,_vue.h)((0,_vue.resolveComponent)("vxe-input"),{ref:V,clearable:m.clearable,placeholder:m.placeholder,readonly:!0,disabled:n,type:"text",prefixIcon:m.prefixIcon,suffixIcon:i?_conf.default.icon.SELECT_LOADED:u?_conf.default.icon.SELECT_OPEN:_conf.default.icon.SELECT_CLOSE,modelValue:a,onClear:f,onClick:_,onFocus:p,onBlur:d,onSuffixClick:_},s?{prefix:function(){return s({})}}:{}),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!t||!o},[(0,_vue.h)("div",{ref:S,class:["vxe-table--ignore-clear vxe-select--panel",((a={})["size--"+r]=r,a["is--transfer"]=t,a["animat--leave"]=!i&&y.animatVisible,a["animat--enter"]=!i&&u,a)],placement:y.panelPlacement,style:y.panelStyle},o?[(0,_vue.h)("div",{ref:P,class:"vxe-select-option--wrapper"},function(){var e=y.visibleGroupList,t=y.visibleOptionList;if(D.value){if(e.length)return M()}else if(t.length)return W(t);return[(0,_vue.h)("div",{class:"vxe-select--empty-placeholder"},m.emptyText||_conf.default.i18n("vxe.select.emptyText"))]}())]:[])])])},(0,_vue.provide)("$xeselect",A),A},render:function(){return this.renderVN()}});exports.default=_default2;