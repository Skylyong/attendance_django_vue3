<template>
  <!-- 管理用户账户，账户添加、删除、密码重置、用户信息修改等 -->

  <!-- <h1>伙伴管理，待开发</h1> -->

  <div>
    <a-form
      :model="formState"
      v-bind="layout"
      class="center"
      name="nest-messages"
      :validate-messages="validateMessages"
      @finish="onFinish"
    >
      <br />
      <br />
      <h1>提交申请</h1>
      <br />
      <br />
      <a-form-item label="申请类型">
        <a-select
          ref="select"
          v-model:value="formState.user.applyType"
          style="width: 180px"
          @change="applyTypeChange"
          :options="options_apply_type"
        >
        </a-select>
      </a-form-item>

      <template v-if="formState.user.applyType == '值班'">
        <a-form-item label="值班日期">
          <a-date-picker
            @ok="onRangeOk"
            @change="onRangeChange"
            v-model:value="formState.user.applyDate"
          />
        </a-form-item>
        <a-form-item label="是否节假  " @click="info">
          <a-radio-group
            v-model:value="formState.user.isHoliday"
            style="margin-right: auto"
          >
            <a-radio :style="radioStyle" :value="1">是</a-radio>
            <a-radio :style="radioStyle" :value="0">否</a-radio>
          </a-radio-group>
        </a-form-item>

        <a-form-item label="值班时长">
          <p style="text-align: left">{{ formState.user.applyTimeLast }}</p>
        </a-form-item>
        <a-form-item label="值班原因">
          <a-textarea
            style="width: 160pt"
            v-model:value="formState.user.applyReason"
            show-count
            :maxlength="50"
          />
        </a-form-item>
      </template>

      <template v-else-if="formState.user.applyType == '加班'">
        <a-form-item label="换算类型">
          <a-radio-group v-model:value="formState.user.conversionType">
            <a-radio :style="radioStyle" :value="0">累加积休</a-radio>
            <a-radio :style="radioStyle" :value="1">加班费</a-radio>
          </a-radio-group>
        </a-form-item>
        <a-form-item label="加班日期">
          <a-range-picker
            style="width: 225px"
            @ok = onRangeOk
            @change="onRangeChange"
            :placeholder="['开始时间', '结束时间']"
            :disabled-time="disabledRangeTime"
            :show-time="{
              format:'HH:mm',
              hideDisabledOptions: true,
            }"
            format="YYYY-MM-DD HH:mm"
          />
        </a-form-item>

        <a-form-item label="加班时长">
          <p style="text-align: left">{{ formState.user.applyTimeLast }}</p>
        </a-form-item>
        <a-form-item label="加班原因">
          <a-textarea
            style="width: 160pt"
            v-model:value="formState.user.applyReason"
            show-count
            :maxlength="50"
          />
        </a-form-item>
      </template>
      <template v-else>
        <a-form-item label="请假时间">
         <a-range-picker
            style="width: 225px"
            @ok = onRangeOk
            @change="onRangeChange"
            :placeholder="['开始时间', '结束时间']"
            :disabled-time="disabledRangeTime"
            :show-time="{
              format:'HH:mm',
              hideDisabledOptions: true,
            }"
            format="YYYY-MM-DD HH:mm"
          />
        </a-form-item>
        <a-form-item label="请假时长">
          <p style="text-align: left">{{ formState.user.applyTimeLast }}</p>
        </a-form-item>
        <a-form-item label="请假原因">
          <a-textarea
            style="width: 160pt"
            v-model:value="formState.user.applyReason"
            show-count
            :maxlength="50"
          />
        </a-form-item>
      </template>
      <br />

      <a-button type="primary" html-type="Submit">提交</a-button>
    </a-form>
  </div>
</template>

<script>
import dayjs from "dayjs";
import { message } from "ant-design-vue";
import { defineComponent, ref, reactive } from "vue";
import moment from "moment";
import { workerApply } from "../../api/api.js";

export default defineComponent({
  setup() {
    const formState = reactive({
      user: {
        applyTimeLast: "",
        applyReason: "",
        applyType: "值班",
        applyDate: "",
        isHoliday: 0,
        conversionType: 1,
      },
    });
    const options_apply_type = ref([
      {
        value: "值班",
        label: "值班",
      },
      {
        value: "加班",
        label: "加班",
      },
      {
        value: "请假",
        label: "请假",
      },
    ]);
    let dataString = ref();
    const onRangeChange = (value, dateString) => {
      dataString = dateString;
      if (formState.user.applyType == "值班") {
        let week = moment(value).day();
        if (week == 0 || week == 6) {
          formState.user.applyTimeLast = "1天4时";
        } else {
          formState.user.applyTimeLast = "4时";
        }
      }
    };

    const onRangeOk = (value) => {
      // console.log(value);
      var hour = moment(value[1]).diff(moment(value[0]), "hour");
      var day = moment(value[1]).diff(moment(value[0]), "day");
      var minutes = moment(value[1]).diff(moment(value[0]), "minutes");
      minutes = minutes - hour*60;
      hour = hour - day * 24;
      hour = hour + minutes/60
      console.log(hour);
      if (hour >= 8) {
        hour = 8;
      }

      formState.user.applyTimeLast =
        day.toString() + "天" + hour.toString() + "时";
    };

    const applyTypeChange = (value) => {
      formState.user.applyTimeLast = "";
      formState.user.applyReason = "";
    };

    const onFinish = (value) => {
      const dataJson = {};
      if (formState.user.applyTimeLast != "") {
        if (
          formState.user.conversionType == 0 &&
          formState.user.applyReason.length == 0
        ) {
          message.error("请输入加班原因!");
        } else {
          if (formState.user.applyType == "值班") {
            dataJson["applyType"] = formState.user.applyType;
            dataJson["applyDate"] = formState.user.applyDate;
            dataJson["isHoliday"] = formState.user.isHoliday;
            dataJson["applyTimeLast"] = formState.user.applyTimeLast;
            dataJson["applyReason"] = formState.user.applyReason;
            dataJson["conversionType"] = 2;
          } else if (formState.user.applyType == "加班") {
            dataJson["applyType"] = formState.user.applyType;
            dataJson["conversionType"] = formState.user.conversionType;
            dataJson["applyDate"] = formState.user.applyDate;
            dataJson["applyTimeLast"] = formState.user.applyTimeLast;
            dataJson["applyReason"] = formState.user.applyReason;
            dataJson["isHoliday"] = 2;
          } else {
            dataJson["applyType"] = formState.user.applyType;
            dataJson["applyDate"] = formState.user.applyDate;
            dataJson["applyTimeLast"] = formState.user.applyTimeLast;
            dataJson["applyReason"] = formState.user.applyReason;
            dataJson["conversionType"] = 2;
            dataJson["isHoliday"] = 2;
          }

          let userid = localStorage.getItem("Userid");
          workerApply(userid, dataJson, dataString).then(
            (response) => {
              if (response["code"] == 1) {
                message.success("提交成功");
              } else {
                message.error("提交失败");
              }
            },
            (response) => {
              message.error("提交提交失败，服务器访问错误！");
            }
          );
        }
      } else {
        message.error("数据录入不完整！");
      }

      // console.log(dataJson);
      // 接下来把dataJson传给后端服务器完成数据提交任务
    };

    const range = (start, end, d_type) => {
      const result = [];
      if (d_type === "hour") {
        for (let i = 0; i < start; i++) {
          result.push(i);
        }
        for (let i = end; i < 24; i++) {
          result.push(i);
        }
      } else if (d_type === "minute") {
        for (let i = 0; i < 60; i++) {
          if (i % start != 0) {
            result.push(i);
          }
        }
      } else {
        for (let i = 0; i < 60; i++) {
          result.push(i);
        }
      }
      return result;
    };


    const disabledRangeTime = () => {
      {
        return {
          disabledHours: () => range(8, 18, "hour"),
          disabledMinutes: () => range(15, 60, "minute"),
          disabledSeconds: () => [55,56],
        };
      }
    };

    return {
      disabledRangeTime,
      dataString,
      onFinish,
      applyTypeChange,
      onRangeChange,
      onRangeOk,
      formState,
      options_apply_type,
      dayjs,
    };
  },
});
</script>

 <style scoped>
.center {
  text-align: center;
  margin: 0 auto;
  width: 300px;
}
</style>>